<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4a6fa5">
    <title>å¤šå¸³å†Šæ™ºèƒ½è¨˜å¸³ç¨‹å¼ (Cloud Sync Edition)</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.5;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            position: relative;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        h1 { font-size: 1.5rem; margin: 0; }
        .date-display { font-size: 0.9rem; opacity: 0.9; }

        /* Cloud Icon */
        .cloud-icon {
            font-size: 1.8rem;
            cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
            transition: transform 0.2s;
        }
        .cloud-icon:active { transform: scale(0.9); }
        .cloud-status-off { color: #ff6b6b; } 
        .cloud-status-on { color: #51cf66; }  

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }

        .tab-btn {
            padding: 8px 16px;
            background-color: white;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            color: #666;
            transition: var(--transition);
            white-space: nowrap;
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(74, 111, 165, 0.3);
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms Layout */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
            position: relative;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-row .form-group { margin-bottom: 0; }

        label {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        
        label span.required { color: var(--accent-color); }

        input, select, textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: #fff;
            width: 100%;
            transition: border-color 0.2s;
            -webkit-appearance: none;
        }
        
        input[type="date"], input[type="time"] { padding: 11px; }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.1);
        }
        
        input:read-only { background-color: #f8f9fa; color: #666; }

        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 10px 0;
            user-select: none;
        }
        .checkbox-container input[type="checkbox"] {
            width: 22px;
            height: 22px;
            cursor: pointer;
            flex-shrink: 0;
            -webkit-appearance: checkbox; /* æ¢å¾©æ¨™æº–å‹¾é¸æ¨£å¼ */
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--accent-color); }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-info { background-color: var(--info-color); }
        .btn-cancel { background-color: #6c757d; }

        /* Type Selector */
        .type-selector {
            display: flex;
            background: #eee;
            padding: 4px;
            border-radius: var(--border-radius);
        }

        .type-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: #666;
            transition: all 0.2s;
        }
        
        .type-option.selected {
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .type-option.income.selected { color: var(--success-color); border-bottom: 3px solid var(--success-color); }
        .type-option.expense.selected { color: var(--accent-color); border-bottom: 3px solid var(--accent-color); }

        /* Filter & Header Row in List Tab */
        .list-action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        .filter-section {
            flex: 1;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
            overflow: hidden;
        }
        .filter-header {
            padding: 12px 15px;
            background: #e9ecef;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--primary-color);
            height: 46px;
        }
        .filter-header::after {
            content: 'â–¼';
            font-size: 0.8rem;
            transition: transform 0.3s;
        }
        .filter-section.collapsed .filter-header::after { transform: rotate(-90deg); }
        .filter-content {
            padding: 15px;
            display: block;
        }
        .filter-section.collapsed .filter-content { display: none; }
        
        .add-new-btn-list {
            width: 100px;
            height: 46px;
            white-space: nowrap;
        }

        /* Record Cards */
        .record-list { display: flex; flex-direction: column; gap: 12px; }
        .record-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border-left: 5px solid #ccc;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            position: relative;
        }
        .record-card:active { transform: scale(0.98); background-color: #f8f9fa; }
        .record-card.income { border-left-color: var(--success-color); }
        .record-card.expense { border-left-color: var(--accent-color); }
        .record-card.excluded { opacity: 0.7; border-left-style: dashed; }
        
        .exclude-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 0.6rem;
            background: #eee;
            padding: 2px 4px;
            border-radius: 4px;
            color: #999;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            pointer-events: none;
        }
        .record-date-block { display: flex; flex-direction: column; }
        .record-date { font-weight: 600; font-size: 0.95rem; }
        .record-time-book { font-size: 0.8rem; color: #888; margin-top: 2px; }
        
        .record-amount-block { text-align: right; }
        .record-amount { font-weight: 700; font-size: 1.1rem; }
        .record-amount.income { color: var(--success-color); }
        .record-amount.expense { color: var(--accent-color); }
        .record-twd { font-size: 0.75rem; color: #999; }

        .record-cat {
            font-size: 0.9rem;
            color: #555;
            background: #f1f3f5;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 8px;
        }
        
        .record-summary-text {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
            padding-left: 5px;
        }

        /* Account Book Style (Modified) */
        .book-list { 
            display: grid; 
            gap: 20px; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            padding: 10px 0;
        }
        .book-card {
            background: white;
            border-radius: 4px 12px 12px 4px;
            border-left: 12px solid var(--primary-color);
            padding: 15px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 180px;
            transition: transform 0.2s;
            cursor: pointer;
        }
        .book-card:hover { transform: translateY(-5px); }
        .book-card::after {
            content: '';
            position: absolute;
            left: 5px; top: 0; bottom: 0;
            width: 2px;
            background: rgba(0,0,0,0.1);
        }
        .book-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; color: var(--dark-color); }
        .book-currency-tag { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; background: #eee; padding: 2px 6px; border-radius: 4px; }
        .book-balance-label { font-size: 0.75rem; color: #888; margin-top: auto; }
        .book-balance-val { font-size: 1.2rem; font-weight: 800; color: var(--primary-color); word-break: break-all; }
        .book-actions { display: flex; gap: 8px; margin-top: 10px; }
        .book-actions button { flex: 1; padding: 4px; font-size: 0.75rem; }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center;
            z-index: 9999; backdrop-filter: blur(2px);
            padding: 20px;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: white; padding: 25px;
            border-radius: var(--border-radius);
            width: 100%; max-width: 400px;
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        /* Detail Modal Specifics */
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .detail-label { color: #666; font-size: 0.9rem; }
        .detail-val { font-weight: 500; text-align: right; }
        .detail-amount { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); padding: 15px 0; text-align: center; }

        /* Notification */
        .notification {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
            padding: 12px 24px;
            background-color: #333; color: white;
            border-radius: 50px;
            z-index: 10000;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 0.9rem;
            white-space: nowrap;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .notification.show { transform: translateX(-50%) translateY(0); }
        .notification.error { background-color: var(--accent-color); }
        .notification.success { background-color: var(--success-color); }

        .hidden { display: none !important; }
        .form-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        /* Stats */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .summary-item { background: #fff; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .summary-val { font-weight: bold; font-size: 1rem; margin-top: 5px; word-break: break-all; }
        .summary-label { font-size: 0.8rem; color: #666; }

        select {
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px;
        }

        /* Spinner */
        .spinner {
            border: 3px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 480px) {
            .book-list { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 320px) {
            .form-row { grid-template-columns: 1fr; gap: 10px; } 
            .summary-grid { grid-template-columns: 1fr; }
            .book-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-top">
                    <div>
                        <h1>ğŸ“’ æ™ºèƒ½è¨˜å¸³ <span style="font-size: 0.8rem; font-weight: normal; opacity: 0.8;">App</span></h1>
                        <div class="date-display" id="currentDate"></div>
                    </div>
                    <div id="cloudSyncBtn" class="cloud-icon cloud-status-off" title="é›²ç«¯åŒæ­¥">â˜ï¸</div>
                </div>
                <div id="headerTotal" style="font-weight: bold; font-size: 1rem; margin-top: 5px; padding-top:5px; border-top:1px solid rgba(255,255,255,0.2);">
                    </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="records">ğŸ“‹ åˆ—è¡¨</button>
            <button class="tab-btn" data-tab="record">ğŸ“ è¨˜å¸³</button>
            <button class="tab-btn" data-tab="books">ğŸ“• å¸³å†Š</button>
            <button class="tab-btn" data-tab="categories">ğŸ“š ç§‘ç›®</button>
            <button class="tab-btn" data-tab="summary">ğŸ“Š çµ±è¨ˆ</button>
            <button class="tab-btn" data-tab="data">âš™ï¸ è¨­å®š</button>
        </div>

        <div class="tab-content active" id="records-tab">
            <div class="list-action-bar">
                <div class="filter-section collapsed" id="filterSection">
                    <div class="filter-header" id="filterHeader">
                        ğŸ” ç¯©é¸æ¢ä»¶
                    </div>
                    <div class="filter-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label>å¹´ä»½</label>
                                <select id="filterYear"><option value="">å…¨éƒ¨</option></select>
                            </div>
                            <div class="form-group">
                                <label>æœˆä»½</label>
                                <select id="filterMonth">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                                    <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                                    <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                                    <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>å¸³å†Š</label>
                                <select id="filterBook"><option value="">å…¨éƒ¨</option></select>
                            </div>
                            <div class="form-group">
                                <label>æ”¶æ”¯</label>
                                <select id="filterType">
                                    <option value="">å…¨éƒ¨</option>
                                    <option value="income">æ”¶å…¥</option>
                                    <option value="expense">æ”¯å‡º</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>ä¸»ç§‘ç›®</label>
                                <select id="filterMainCategory"><option value="">å…¨éƒ¨</option></select>
                            </div>
                            <div class="form-group">
                                <label>å­ç§‘ç›®</label>
                                <select id="filterSubCategory"><option value="">å…¨éƒ¨</option></select>
                            </div>
                        </div>

                        <div class="form-group">
                            <input type="text" id="filterKeyword" placeholder="æœå°‹æ‘˜è¦é—œéµå­—...">
                        </div>

                        <div class="btn-group">
                            <button class="btn" id="applyFilterBtn">ğŸ” æœå°‹</button>
                            <button class="btn btn-cancel" id="clearFilterBtn">æ¸…é™¤</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success add-new-btn-list" id="listAddNewBtn">ï¼‹ æ–°å¢</button>
            </div>
            
            <div id="recordsInfoText" style="margin-bottom:10px; font-size:0.85rem; color:#666;"></div>
            <div id="recordsList" class="record-list"></div>
        </div>

        <div class="tab-content" id="record-tab">
            <div class="form-title">
                <h2 id="formModeTitle">æ–°å¢è¨˜éŒ„</h2>
                <button id="cancelEditBtn" class="btn btn-cancel hidden" style="width: auto; padding: 5px 10px; font-size: 0.8rem;">å–æ¶ˆ</button>
            </div>
            
            <form id="recordForm">
                <div class="form-group">
                    <label for="recordBook">å¸³å†Š <span class="required">*</span></label>
                    <select id="recordBook" required></select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="recordDate">æ—¥æœŸ</label>
                        <input type="date" id="recordDate" required>
                    </div>
                    <div class="form-group">
                        <label for="recordTime">æ™‚é–“</label>
                        <input type="time" id="recordTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <div class="type-selector">
                        <div class="type-option expense selected" data-type="expense">æ”¯å‡º</div>
                        <div class="type-option income" data-type="income">æ”¶å…¥</div>
                    </div>
                    <input type="hidden" id="recordType" value="expense">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="recordMainCategory">ä¸»ç§‘ç›® <span class="required">*</span></label>
                        <select id="recordMainCategory" required>
                            <option value="">è«‹é¸æ“‡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordSubCategory">å­ç§‘ç›®</label>
                        <select id="recordSubCategory" required>
                            <option value="">...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="recordCurrency">å¹£åˆ¥</label>
                        <input type="text" id="recordCurrency" readonly style="background-color: #eee;">
                    </div>
                    <div class="form-group">
                        <label for="recordRate">åŒ¯ç‡</label>
                        <input type="number" id="recordRate" step="0.0001" min="0" required>
                    </div>
                </div>

                <div class="form-row" style="align-items: flex-end;">
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="recordExclude"> 
                            <span>ä¸åˆ—å…¥æ”¶æ”¯çµ±è¨ˆ</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="recordAmount">é‡‘é¡ <span class="required">*</span></label>
                        <input type="number" id="recordAmount" min="0" step="0.01" placeholder="0.00" required style="font-size: 1.2rem; font-weight: bold; padding: 12px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recordSummary">æ‘˜è¦ / å‚™è¨»</label>
                    <textarea id="recordSummary" rows="2" placeholder="é¸å¡«..."></textarea>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-success" id="submitFormBtn">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" class="btn" id="resetFormBtn" style="background:#ddd; color:#333">é‡ç½®</button>
                </div>
            </form>
        </div>

        <div class="tab-content" id="books-tab">
            <div class="form-title">
                <h2>å¸³å†Šç®¡ç†</h2>
                <button class="btn btn-success" id="showAddBookModalBtn" style="width: auto;">ï¼‹ æ–°å¢å¸³å†Š</button>
            </div>
            <div id="bookListContainer" class="book-list"></div>
        </div>

        <div class="tab-content" id="categories-tab">
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom:10px; color:var(--primary-color);">ä¸»ç§‘ç›®</h3>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <input type="text" id="newMainCatInput" placeholder="åç¨±">
                    <button class="btn btn-success" id="addMainCatBtn" style="width: 80px;">æ–°å¢</button>
                </div>
                <div id="mainCatList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
            </div>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <div>
                <h3 style="margin-bottom:10px; color:var(--secondary-color);">å­ç§‘ç›®</h3>
                <p id="selectedMainCatLabel" style="font-size:0.9rem; color:#666; margin-bottom:5px;">è«‹å…ˆé»é¸ä¸Šæ–¹ä¸»ç§‘ç›®</p>
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <input type="text" id="newSubCatInput" placeholder="åç¨±" disabled>
                    <button class="btn btn-success" id="addSubCatBtn" style="width: 80px;" disabled>æ–°å¢</button>
                </div>
                <div id="subCatList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
            </div>
        </div>

        <div class="tab-content" id="summary-tab">
            <div class="filter-section">
                <div class="form-row">
                    <div class="form-group">
                        <label>å¹´ä»½</label>
                        <select id="summaryYear"><option value="">å…¨éƒ¨</option></select>
                    </div>
                    <div class="form-group">
                        <label>æœˆä»½</label>
                        <select id="summaryMonth">
                            <option value="">å…¨éƒ¨</option>
                            <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>å¸³å†Š (é è¨­è·¨å¸³å†Š)</label>
                    <select id="summaryBook"><option value="">å…¨éƒ¨</option></select>
                </div>

                <button class="btn" id="runSummaryBtn">ğŸ“Š ç”¢ç”Ÿå ±è¡¨</button>
            </div>

            <div id="summaryResults" class="hidden">
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">ç¸½æ”¶å…¥</div>
                        <div class="summary-val" id="sumIncome" style="color:var(--success-color)">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ç¸½æ”¯å‡º</div>
                        <div class="summary-val" id="sumExpense" style="color:var(--accent-color)">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">æ·¨åˆ©</div>
                        <div class="summary-val" id="sumNet">0</div>
                    </div>
                </div>
                
                <h3 style="font-size:1rem; margin-bottom:10px; border-left:4px solid var(--accent-color); padding-left:10px;">æ”¯å‡ºåˆ†ä½ˆ</h3>
                <div id="expenseCatChart"></div>
                
                <h3 style="font-size:1rem; margin:20px 0 10px 0; border-left:4px solid var(--success-color); padding-left:10px;">æ”¶å…¥åˆ†ä½ˆ</h3>
                <div id="incomeCatChart"></div>
            </div>
        </div>
        
        <div class="tab-content" id="data-tab">
            <h3>è³‡æ–™ç¶­è­·</h3>
            <div class="btn-group" style="flex-direction: column;">
                <button class="btn btn-info" id="exportDataBtn">ğŸ“¤ åŒ¯å‡ºè³‡æ–™ (JSON)</button>
                <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (JSON)</button>
                <input type="file" id="importFile" accept=".json" class="hidden">
                <button class="btn btn-danger" id="clearAllDataBtn" style="margin-top:20px;">âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>
    </div>

    <div id="bookModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="bookModalTitle">æ–°å¢å¸³å†Š</h3>
                <span class="close-modal" style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('bookModal').classList.remove('show')">&times;</span>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="form-group">
                    <label>åç¨±</label>
                    <input type="text" id="bookName" required>
                </div>
                <div class="form-group">
                    <label>ç”¨é€”</label>
                    <input type="text" id="bookPurpose">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å¹£åˆ¥</label>
                        <select id="bookCurrency" required>
                            <option value="TWD">å°å¹£ (TWD)</option>
                            <option value="USD">ç¾é‡‘ (USD)</option>
                            <option value="JPY">æ—¥åœ“ (JPY)</option>
                            <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                            <option value="EUR">æ­å…ƒ (EUR)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æœŸåˆé‡‘é¡</label>
                        <input type="number" id="bookInitialBalance" step="0.01" value="0">
                    </div>
                </div>
                <button type="submit" class="btn btn-success">å„²å­˜</button>
            </form>
        </div>
    </div>

    <div id="cloudModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>â˜ï¸ é›²ç«¯åŒæ­¥è¨­å®š (GitHub)</h3>
                <span class="close-modal" style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('cloudModal').classList.remove('show')">&times;</span>
            </div>
            <div class="form-group">
                <label>Access Token (PAT)</label>
                <input type="password" id="ghToken" placeholder="ghp_..." autocomplete="off">
            </div>
            <div class="form-group">
                <label>Gist ID (ç•™ç©ºå‰‡è‡ªå‹•å»ºç«‹)</label>
                <input type="text" id="ghGistId" placeholder="e.g. 5d8e...">
            </div>
            <div id="syncStatus" style="margin-bottom:10px; font-size:0.9rem;"></div>
            <div class="btn-group" style="flex-direction: column;">
                <button class="btn btn-success" id="saveCloudSettingsBtn">é€£ç·šä¸¦åŒæ­¥</button>
                <button class="btn btn-danger" id="disconnectCloudBtn">ä¸­æ–·é€£ç·š</button>
            </div>
        </div>
    </div>

    <div id="conflictModal" class="modal" style="z-index: 10001;">
        <div class="modal-content">
            <h3>âš ï¸ è³‡æ–™åŒæ­¥è¡çª</h3>
            <p style="margin:15px 0; color:#555;">é›²ç«¯èˆ‡æœ¬åœ°ç«¯çš†æœ‰è³‡æ–™ï¼Œè«‹é¸æ“‡åŒæ­¥æ–¹å¼ï¼š</p>
            <div class="btn-group" style="flex-direction: column;">
                <button class="btn btn-danger" onclick="resolveConflict('overwrite_local')">ä¸‹è¼‰é›²ç«¯è³‡æ–™ (è¦†è“‹æœ¬åœ°)</button>
                <button class="btn btn-warning" onclick="resolveConflict('overwrite_cloud')">ä¸Šå‚³æœ¬åœ°è³‡æ–™ (è¦†è“‹é›²ç«¯)</button>
                <button class="btn btn-info" onclick="resolveConflict('merge')">åˆä½µè³‡æ–™ (ä¿ç•™å…©é‚Š)</button>
            </div>
        </div>
    </div>

    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <h3 id="detailTitle">è¨˜éŒ„è©³æƒ…</h3>
                <span class="close-modal" style="font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('detailModal').classList.remove('show')">&times;</span>
            </div>
            <div id="detailContent"></div>
            <div class="btn-group" style="margin-top:20px;">
                <button class="btn btn-warning" id="editDetailBtn">ç·¨è¼¯</button>
                <button class="btn btn-danger" id="deleteDetailBtn">åˆªé™¤</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™ ---
        const DEFAULT_CATEGORIES = {
            'é£²é£Ÿ': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'é£²æ–™', 'é›¶é£Ÿ'],
            'äº¤é€š': ['å…¬è»Š', 'æ·é‹', 'è¨ˆç¨‹è»Š', 'æ²¹è³‡', 'åœè»Šè²»'],
            'å¨›æ¨‚': ['é›»å½±', 'KTV', 'æ—…éŠ', 'é‹å‹•', 'éŠæˆ²'],
            'ç”Ÿæ´»': ['æˆ¿ç§Ÿ', 'æ°´é›»', 'ç¶²è·¯', 'æ‰‹æ©Ÿ', 'æ—¥ç”¨å“'],
            'æ”¶å…¥': ['è–ªæ°´', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'],
            'å…¶ä»–': ['é†«ç™‚', 'æ•™è‚²', 'ç¦®ç‰©', 'ææ¬¾']
        };

        const BASE_RATES = {
            'TWD': 1, 'USD': 32.5, 'CNY': 4.5, 'JPY': 0.22, 'EUR': 35.0
        };

        const appState = {
            records: [],
            categories: {},
            accountBooks: [],
            editingRecordId: null,
            editingBookId: null,
            currentMainCat: null,
            githubConfig: {
                gistId: '',
                filename: 'money_tracker_data.json'
            }
        };

        let ghToken = '';
        let pendingCloudData = null;

        // --- å·¥å…· ---
        const utils = {
            uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatMoney: (amount, currency = 'TWD') => {
                return new Intl.NumberFormat('zh-TW', { 
                    minimumFractionDigits: currency === 'JPY' ? 0 : 2,
                    maximumFractionDigits: 2
                }).format(amount);
            },
            showNotify: (msg, type = 'success') => {
                const el = document.getElementById('notification');
                el.textContent = msg;
                el.className = `notification show ${type}`;
                setTimeout(() => el.classList.remove('show'), 2500);
            },
            save: () => {
                localStorage.setItem('acc_records', JSON.stringify(appState.records));
                localStorage.setItem('acc_categories', JSON.stringify(appState.categories));
                localStorage.setItem('acc_books', JSON.stringify(appState.accountBooks));
                localStorage.setItem('acc_gh_config', JSON.stringify(appState.githubConfig));
            },
            getToday: () => new Date().toISOString().split('T')[0],
            getTime: () => new Date().toTimeString().split(' ')[0].substr(0, 5)
        };

        // --- åˆå§‹åŒ– ---
        function initApp() {
            const storedRecords = localStorage.getItem('acc_records');
            const storedCats = localStorage.getItem('acc_categories');
            const storedBooks = localStorage.getItem('acc_books');
            const storedGhConfig = localStorage.getItem('acc_gh_config');
            const storedToken = localStorage.getItem('acc_gh_token');

            appState.categories = storedCats ? JSON.parse(storedCats) : DEFAULT_CATEGORIES;
            appState.accountBooks = storedBooks ? JSON.parse(storedBooks) : [];
            appState.records = storedRecords ? JSON.parse(storedRecords) : [];
            if(storedGhConfig) appState.githubConfig = JSON.parse(storedGhConfig);
            if(storedToken) ghToken = storedToken;

            if (appState.accountBooks.length === 0) {
                appState.accountBooks.push({
                    id: 'default_book',
                    name: 'é è¨­å¸³æœ¬',
                    purpose: 'ç³»çµ±è‡ªå‹•å»ºç«‹',
                    currency: 'TWD',
                    initialBalance: 0,
                    createdAt: new Date().toISOString()
                });
            }

            const dateStr = new Date().toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'short'});
            document.getElementById('currentDate').textContent = dateStr;
            
            initEvents();
            renderSelects();
            renderBookList();
            renderCategoryManagement();
            renderYearSelects();

            document.getElementById('recordDate').value = utils.getToday();
            document.getElementById('recordTime').value = utils.getTime();

            filterRecords(true); // é è¨­é¡¯ç¤ºæœ€è¿‘è¨˜éŒ„
            updateHeaderTotal();
            updateCloudIconStatus();
        }

        // --- äº‹ä»¶ ---
        function initEvents() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
                    
                    if(btn.dataset.tab === 'records') filterRecords(true);
                    if(btn.dataset.tab === 'books') renderBookList();
                });
            });

            document.getElementById('listAddNewBtn').addEventListener('click', () => {
                document.querySelector('[data-tab="record"]').click();
                exitEditMode();
            });

            document.getElementById('filterHeader').addEventListener('click', () => {
                document.getElementById('filterSection').classList.toggle('collapsed');
            });

            document.querySelectorAll('.type-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('recordType').value = this.dataset.type;
                });
            });

            document.getElementById('recordBook').addEventListener('change', function() {
                const book = appState.accountBooks.find(b => b.id === this.value);
                if (book) {
                    document.getElementById('recordCurrency').value = book.currency;
                    document.getElementById('recordRate').value = BASE_RATES[book.currency] || 1;
                    document.getElementById('recordRate').readOnly = (book.currency === 'TWD');
                }
            });

            document.getElementById('recordMainCategory').addEventListener('change', (e) => updateSubSelect('recordSubCategory', e.target.value));
            document.getElementById('filterMainCategory').addEventListener('change', (e) => updateSubSelect('filterSubCategory', e.target.value));

            document.getElementById('recordForm').addEventListener('submit', handleRecordSubmit);
            document.getElementById('resetFormBtn').addEventListener('click', resetForm);
            document.getElementById('cancelEditBtn').addEventListener('click', exitEditMode);

            document.getElementById('applyFilterBtn').addEventListener('click', () => {
                filterRecords();
                document.getElementById('filterSection').classList.add('collapsed');
            });
            document.getElementById('clearFilterBtn').addEventListener('click', () => {
                document.querySelectorAll('#records-tab select').forEach(s => s.value = '');
                document.getElementById('filterKeyword').value = '';
                filterRecords();
            });

            document.getElementById('showAddBookModalBtn').addEventListener('click', () => {
                appState.editingBookId = null;
                document.getElementById('bookForm').reset();
                document.getElementById('bookModalTitle').textContent = 'æ–°å¢å¸³å†Š';
                document.getElementById('bookCurrency').disabled = false;
                document.getElementById('bookModal').classList.add('show');
            });
            document.getElementById('bookForm').addEventListener('submit', handleBookSubmit);

            document.getElementById('addMainCatBtn').addEventListener('click', () => {
                const val = document.getElementById('newMainCatInput').value.trim();
                if(val && !appState.categories[val]) {
                    appState.categories[val] = [];
                    utils.save();
                    renderCategoryManagement();
                    renderSelects();
                    document.getElementById('newMainCatInput').value = '';
                    utils.showNotify('ä¸»ç§‘ç›®å·²æ–°å¢');
                }
            });
            document.getElementById('addSubCatBtn').addEventListener('click', () => {
                const val = document.getElementById('newSubCatInput').value.trim();
                if(val && appState.currentMainCat) {
                    if(!appState.categories[appState.currentMainCat].includes(val)) {
                        appState.categories[appState.currentMainCat].push(val);
                        utils.save();
                        selectMainCatForEdit(appState.currentMainCat);
                        document.getElementById('newSubCatInput').value = '';
                        utils.showNotify('å­ç§‘ç›®å·²æ–°å¢');
                    }
                }
            });

            document.getElementById('runSummaryBtn').addEventListener('click', runSummary);
            document.getElementById('cloudSyncBtn').addEventListener('click', openCloudSettings);
            document.getElementById('saveCloudSettingsBtn').addEventListener('click', handleConnectCloud);
            document.getElementById('disconnectCloudBtn').addEventListener('click', handleDisconnectCloud);

            document.getElementById('editDetailBtn').addEventListener('click', () => {
                document.getElementById('detailModal').classList.remove('show');
                editRecord(appState.currentDetailId);
            });
            document.getElementById('deleteDetailBtn').addEventListener('click', () => {
                document.getElementById('detailModal').classList.remove('show');
                deleteRecord(appState.currentDetailId);
            });
        }

        // --- æ ¸å¿ƒé‚è¼¯ ---
        function handleRecordSubmit(e) {
            e.preventDefault();
            const bookId = document.getElementById('recordBook').value;
            const book = appState.accountBooks.find(b => b.id === bookId);
            
            const record = {
                id: appState.editingRecordId || utils.uuid(),
                bookId: bookId,
                date: document.getElementById('recordDate').value,
                time: document.getElementById('recordTime').value,
                type: document.getElementById('recordType').value,
                mainCategory: document.getElementById('recordMainCategory').value,
                subCategory: document.getElementById('recordSubCategory').value,
                currency: book.currency,
                exchangeRate: parseFloat(document.getElementById('recordRate').value),
                amount: parseFloat(document.getElementById('recordAmount').value),
                summary: document.getElementById('recordSummary').value,
                excludeFromStats: document.getElementById('recordExclude').checked,
                updatedAt: new Date().toISOString()
            };

            if (appState.editingRecordId) {
                const idx = appState.records.findIndex(r => r.id === appState.editingRecordId);
                if (idx !== -1) appState.records[idx] = record;
                utils.showNotify('å·²æ›´æ–°');
            } else {
                appState.records.unshift(record);
                utils.showNotify('å·²å„²å­˜');
            }
            
            utils.save();
            updateHeaderTotal();
            resetForm();
            
            document.querySelector('[data-tab="records"]').click();
            filterRecords(true);
        }

        function handleBookSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('bookName').value;
            const purpose = document.getElementById('bookPurpose').value;
            const currency = document.getElementById('bookCurrency').value;
            const initialBalance = parseFloat(document.getElementById('bookInitialBalance').value) || 0;

            if (appState.editingBookId) {
                const book = appState.accountBooks.find(b => b.id === appState.editingBookId);
                book.name = name;
                book.purpose = purpose;
                book.initialBalance = initialBalance;
                utils.showNotify('å¸³å†Šå·²æ›´æ–°');
            } else {
                appState.accountBooks.push({
                    id: utils.uuid(), name, purpose, currency, initialBalance, createdAt: new Date().toISOString()
                });
                utils.showNotify('å¸³å†Šå·²å»ºç«‹');
            }
            utils.save();
            renderBookList();
            renderSelects();
            document.getElementById('bookModal').classList.remove('show');
        }

        function filterRecords(isDefaultLoad = false) {
            const y = document.getElementById('filterYear').value;
            const m = document.getElementById('filterMonth').value;
            const b = document.getElementById('filterBook').value;
            const t = document.getElementById('filterType').value;
            const mc = document.getElementById('filterMainCategory').value;
            const sc = document.getElementById('filterSubCategory').value;
            const k = document.getElementById('filterKeyword').value.toLowerCase();

            const isFilterEmpty = !y && !m && !b && !t && !mc && !sc && !k;
            let dateThreshold = null;
            
            if (isDefaultLoad && isFilterEmpty) {
                const d = new Date();
                d.setMonth(d.getMonth() - 1);
                dateThreshold = d.toISOString().split('T')[0];
                document.getElementById('recordsInfoText').textContent = `é¡¯ç¤ºæœ€è¿‘ä¸€å€‹æœˆçš„è¨˜éŒ„`;
            } else {
                document.getElementById('recordsInfoText').textContent = isFilterEmpty ? `é¡¯ç¤ºå…¨éƒ¨è¨˜éŒ„` : `æœå°‹çµæœ`;
            }

            const filtered = appState.records.filter(r => {
                if (dateThreshold && r.date < dateThreshold) return false;
                if (y && r.date.substring(0, 4) !== y) return false;
                if (m && r.date.substring(5, 7) !== m) return false;
                if (b && r.bookId !== b) return false;
                if (t && r.type !== t) return false;
                if (mc && r.mainCategory !== mc) return false;
                if (sc && r.subCategory !== sc) return false;
                if (k && (!r.summary || !r.summary.toLowerCase().includes(k))) return false;
                return true;
            });

            renderRecordList(filtered);
        }

        function renderRecordList(data) {
            const container = document.getElementById('recordsList');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">æ²’æœ‰è¨˜éŒ„</div>';
                return;
            }
            data.sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time));
            data.forEach(r => {
                const book = appState.accountBooks.find(b => b.id === r.bookId);
                const sign = r.type === 'income' ? '+' : '-';
                let twdInfo = '';
                if (r.currency !== 'TWD') {
                    twdInfo = `<div class="record-twd">â‰ˆ TWD ${utils.formatMoney(Math.round(r.amount * r.exchangeRate))}</div>`;
                }
                const div = document.createElement('div');
                div.className = `record-card ${r.type} ${r.excludeFromStats ? 'excluded' : ''}`;
                div.onclick = () => openDetail(r.id);
                div.innerHTML = `
                    ${r.excludeFromStats ? '<span class="exclude-badge">ä¸è¨ˆçµ±è¨ˆ</span>' : ''}
                    <div class="record-header">
                        <div class="record-date-block">
                            <div class="record-date">${r.date.substring(5)} ${r.time}</div>
                            <div class="record-time-book">ğŸ“’ ${book ? book.name : '?'}</div>
                        </div>
                        <div class="record-amount-block">
                            <div class="record-amount ${r.type}">${sign} ${utils.formatMoney(r.amount, r.currency)} <small style="font-size:0.7rem; color:#888;">${r.currency}</small></div>
                            ${twdInfo}
                        </div>
                    </div>
                    <div class="record-cat">${r.mainCategory} > ${r.subCategory}</div>
                    ${r.summary ? `<div class="record-summary-text">${r.summary}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        function runSummary() {
            const y = document.getElementById('summaryYear').value;
            const m = document.getElementById('summaryMonth').value;
            const b = document.getElementById('summaryBook').value;
            let inc = 0, exp = 0;
            const expCats = {}, incCats = {};

            appState.records.forEach(r => {
                if (r.excludeFromStats) return;
                if (y && r.date.substring(0, 4) !== y) return;
                if (m && r.date.substring(5, 7) !== m) return;
                if (b && r.bookId !== b) return;
                const twd = r.amount * r.exchangeRate;
                if (r.type === 'income') {
                    inc += twd; incCats[r.mainCategory] = (incCats[r.mainCategory] || 0) + twd;
                } else {
                    exp += twd; expCats[r.mainCategory] = (expCats[r.mainCategory] || 0) + twd;
                }
            });

            document.getElementById('sumIncome').textContent = utils.formatMoney(inc);
            document.getElementById('sumExpense').textContent = utils.formatMoney(exp);
            document.getElementById('sumNet').textContent = utils.formatMoney(inc - exp);
            document.getElementById('sumNet').style.color = (inc - exp) >= 0 ? 'var(--success-color)' : 'var(--accent-color)';
            renderBarChart('expenseCatChart', expCats, exp, 'var(--accent-color)');
            renderBarChart('incomeCatChart', incCats, inc, 'var(--success-color)');
            document.getElementById('summaryResults').classList.remove('hidden');
        }

        function renderBookList() {
            const el = document.getElementById('bookListContainer');
            el.innerHTML = '';
            appState.accountBooks.forEach(b => {
                let balance = parseFloat(b.initialBalance || 0);
                appState.records.forEach(r => {
                    if (r.bookId === b.id) {
                        if (r.type === 'income') balance += r.amount;
                        else balance -= r.amount;
                    }
                });

                const div = document.createElement('div');
                div.className = 'book-card';
                // æ ¹æ“šå¹£åˆ¥çµ¦äºˆä¸åŒé¡è‰²
                const colorMap = {'TWD':'#4a6fa5', 'USD':'#28a745', 'JPY':'#ff6b6b', 'CNY':'#ffc107', 'EUR':'#17a2b8'};
                div.style.borderLeftColor = colorMap[b.currency] || '#4a6fa5';
                
                div.innerHTML = `
                    <div class="book-currency-tag">${b.currency}</div>
                    <div>
                        <div class="book-title">${b.name}</div>
                        <div style="font-size:0.7rem; color:#999; line-height:1.2;">${b.purpose || ''}</div>
                    </div>
                    <div>
                        <div class="book-balance-label">ç›®å‰é¤˜é¡</div>
                        <div class="book-balance-val">${utils.formatMoney(balance, b.currency)}</div>
                    </div>
                    <div class="book-actions">
                        <button class="btn btn-warning" onclick="editBook('${b.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-danger" onclick="deleteBook('${b.id}')">åˆªé™¤</button>
                    </div>
                `;
                el.appendChild(div);
            });
        }

        function updateHeaderTotal() {
            const ym = new Date().toISOString().substring(0, 7);
            let total = 0;
            appState.records.forEach(r => {
                if(!r.excludeFromStats && r.date.startsWith(ym) && r.type === 'expense') {
                    total += r.amount * r.exchangeRate;
                }
            });
            document.getElementById('headerTotal').innerHTML = `æœ¬æœˆæ”¯å‡ºçµ±è¨ˆ: <span style="color:#ffcc00">${utils.formatMoney(total)}</span>`;
        }

        function resetForm() {
            document.getElementById('recordForm').reset();
            document.getElementById('recordDate').value = utils.getToday();
            document.getElementById('recordTime').value = utils.getTime();
            document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
            document.querySelector('.type-option.expense').classList.add('selected');
            document.getElementById('recordType').value = 'expense';
            document.getElementById('recordExclude').checked = false;
            if (appState.accountBooks.length > 0) {
                document.getElementById('recordBook').value = appState.accountBooks[0].id;
                document.getElementById('recordBook').dispatchEvent(new Event('change'));
            }
            document.getElementById('recordSubCategory').innerHTML = '<option value="">...</option>';
        }

        window.editRecord = (id) => {
            const r = appState.records.find(i => i.id === id);
            if (!r) return;
            appState.editingRecordId = id;
            document.querySelector('[data-tab="record"]').click();
            document.getElementById('formModeTitle').textContent = 'ç·¨è¼¯è¨˜éŒ„';
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('recordBook').value = r.bookId;
            document.getElementById('recordDate').value = r.date;
            document.getElementById('recordTime').value = r.time;
            document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.type-option.${r.type}`).classList.add('selected');
            document.getElementById('recordType').value = r.type;
            document.getElementById('recordMainCategory').value = r.mainCategory;
            updateSubSelect('recordSubCategory', r.mainCategory);
            document.getElementById('recordSubCategory').value = r.subCategory;
            document.getElementById('recordBook').dispatchEvent(new Event('change'));
            document.getElementById('recordRate').value = r.exchangeRate; 
            document.getElementById('recordAmount').value = r.amount;
            document.getElementById('recordSummary').value = r.summary || '';
            document.getElementById('recordExclude').checked = r.excludeFromStats || false;
        };

        window.exitEditMode = () => {
            appState.editingRecordId = null;
            document.getElementById('formModeTitle').textContent = 'æ–°å¢è¨˜éŒ„';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            resetForm();
        };

        window.deleteRecord = (id) => {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                appState.records = appState.records.filter(r => r.id !== id);
                utils.save(); filterRecords(); updateHeaderTotal();
                utils.showNotify('å·²åˆªé™¤', 'error');
            }
        };

        window.editBook = (id) => {
            const b = appState.accountBooks.find(i => i.id === id);
            appState.editingBookId = id;
            document.getElementById('bookName').value = b.name;
            document.getElementById('bookPurpose').value = b.purpose;
            document.getElementById('bookCurrency').value = b.currency;
            document.getElementById('bookInitialBalance').value = b.initialBalance || 0;
            document.getElementById('bookCurrency').disabled = true;
            document.getElementById('bookModalTitle').textContent = 'ç·¨è¼¯å¸³å†Š';
            document.getElementById('bookModal').classList.add('show');
        };

        window.deleteBook = (id) => {
            if (appState.records.some(r => r.bookId === id)) { alert('å¸³å†Šå…§æœ‰è¨˜éŒ„ï¼Œç„¡æ³•åˆªé™¤'); return; }
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                appState.accountBooks = appState.accountBooks.filter(b => b.id !== id);
                utils.save(); renderBookList(); renderSelects();
            }
        };

        function openDetail(id) {
            const r = appState.records.find(i => i.id === id);
            if (!r) return;
            appState.currentDetailId = id;
            const book = appState.accountBooks.find(b => b.id === r.bookId);
            const color = r.type === 'income' ? 'var(--success-color)' : 'var(--accent-color)';
            document.getElementById('detailContent').innerHTML = `
                <div class="detail-amount" style="color:${color}">${r.type === 'income' ? '+' : '-'} ${utils.formatMoney(r.amount, r.currency)}</div>
                ${r.excludeFromStats ? '<div style="text-align:center; color:#999; font-size:0.8rem; margin-top:-10px;">(ä¸åˆ—å…¥æ”¶æ”¯çµ±è¨ˆ)</div>' : ''}
                <div class="detail-row"><span class="detail-label">é¡å‹</span><span class="detail-val">${r.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</span></div>
                <div class="detail-row"><span class="detail-label">æ—¥æœŸ</span><span class="detail-val">${r.date} ${r.time}</span></div>
                <div class="detail-row"><span class="detail-label">å¸³å†Š</span><span class="detail-val">${book ? book.name : 'æœªçŸ¥'}</span></div>
                <div class="detail-row"><span class="detail-label">ç§‘ç›®</span><span class="detail-val">${r.mainCategory} - ${r.subCategory}</span></div>
                ${r.summary ? `<div style="margin-top:10px;"><div class="detail-label">å‚™è¨»</div><div style="background:#f8f9fa;padding:10px;border-radius:8px;margin-top:5px;">${r.summary}</div></div>` : ''}
            `;
            document.getElementById('detailModal').classList.add('show');
        }

        function renderSelects() {
            const bookOpts = appState.accountBooks.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            document.getElementById('recordBook').innerHTML = bookOpts;
            document.getElementById('filterBook').innerHTML = '<option value="">å…¨éƒ¨</option>' + bookOpts;
            document.getElementById('summaryBook').innerHTML = '<option value="">å…¨éƒ¨</option>' + bookOpts;
            const catOpts = Object.keys(appState.categories).map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('recordMainCategory').innerHTML = '<option value="">è«‹é¸æ“‡</option>' + catOpts;
            document.getElementById('filterMainCategory').innerHTML = '<option value="">å…¨éƒ¨</option>' + catOpts;
            if (appState.accountBooks.length > 0) document.getElementById('recordBook').dispatchEvent(new Event('change'));
        }

        function updateSubSelect(id, main) {
            const el = document.getElementById(id);
            const isFilter = id.includes('filter');
            el.innerHTML = isFilter ? '<option value="">å…¨éƒ¨</option>' : '<option value="">...</option>';
            if (main && appState.categories[main]) {
                appState.categories[main].forEach(s => el.innerHTML += `<option value="${s}">${s}</option>`);
            }
        }

        function renderYearSelects() {
            const years = new Set(appState.records.map(r => r.date.substring(0, 4)));
            years.add(new Date().getFullYear().toString());
            const opts = '<option value="">å…¨éƒ¨</option>' + Array.from(years).sort().reverse().map(y => `<option value="${y}">${y}å¹´</option>`).join('');
            document.getElementById('filterYear').innerHTML = opts;
            document.getElementById('summaryYear').innerHTML = opts;
        }

        function renderCategoryManagement() {
            const el = document.getElementById('mainCatList'); el.innerHTML = '';
            Object.keys(appState.categories).forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'btn'; btn.style.width = 'auto'; btn.style.padding = '5px 10px'; btn.style.fontSize = '0.9rem'; btn.style.backgroundColor = '#e3f2fd'; btn.style.color = '#333';
                btn.textContent = c; btn.onclick = () => selectMainCatForEdit(c); el.appendChild(btn);
            });
        }

        function selectMainCatForEdit(c) {
            appState.currentMainCat = c;
            document.getElementById('selectedMainCatLabel').textContent = `å·²é¸æ“‡ï¼š${c}`;
            document.getElementById('newSubCatInput').disabled = false;
            document.getElementById('addSubCatBtn').disabled = false;
            const el = document.getElementById('subCatList'); el.innerHTML = '';
            appState.categories[c].forEach(s => {
                const tag = document.createElement('span'); tag.style.background = '#eee'; tag.style.padding = '4px 8px'; tag.style.borderRadius = '4px'; tag.style.fontSize = '0.85rem'; tag.textContent = s; el.appendChild(tag);
            });
        }

        function renderBarChart(id, data, total, color) {
            const el = document.getElementById(id); el.innerHTML = '';
            if (total === 0) { el.innerHTML = '<p style="color:#999;font-size:0.9rem;">ç„¡æ•¸æ“š</p>'; return; }
            Object.entries(data).sort((a,b)=>b[1]-a[1]).forEach(([k, v]) => {
                const pct = Math.round((v/total)*100);
                el.innerHTML += `
                    <div style="margin-bottom:8px;">
                        <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-bottom:2px;"><span>${k}</span><span>${utils.formatMoney(v)} (${pct}%)</span></div>
                        <div style="height:6px; background:#eee; border-radius:3px; overflow:hidden;"><div style="height:100%; width:${pct}%; background:${color};"></div></div>
                    </div>`;
            });
        }

        async function createGist(token) {
            const response = await fetch('https://api.github.com/gists', {
                method: 'POST',
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ description: "Money Tracker App Data", public: false, files: { [appState.githubConfig.filename]: { content: JSON.stringify(appState) } } })
            });
            if (!response.ok) throw new Error('ç„¡æ³•å»ºç«‹ Gist');
            const data = await response.json(); return data.id;
        }
        async function getGistContent(token, gistId) {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { 'Authorization': `token ${token}` } });
            if (!response.ok) throw new Error('è®€å– Gist å¤±æ•—');
            const data = await response.json(); const file = data.files[appState.githubConfig.filename];
            return file ? JSON.parse(file.content) : null;
        }
        async function updateGist(token, gistId, dataObj) {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH',
                headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: { [appState.githubConfig.filename]: { content: JSON.stringify(dataObj) } } })
            });
            if (!response.ok) throw new Error('æ›´æ–° Gist å¤±æ•—');
        }
        async function handleConnectCloud() {
            const token = document.getElementById('ghToken').value.trim();
            const gistId = document.getElementById('ghGistId').value.trim();
            const btn = document.getElementById('saveCloudSettingsBtn');
            const statusDiv = document.getElementById('syncStatus');
            if (!token) { statusDiv.textContent = 'âŒ è«‹è¼¸å…¥ Access Token'; return; }
            btn.disabled = true; btn.innerHTML = 'é€£ç·šä¸­... <span class="spinner"></span>';
            try {
                let targetGistId = gistId;
                if (!targetGistId) targetGistId = await createGist(token);
                const cloudContent = await getGistContent(token, targetGistId);
                const localHasData = appState.records.length > 0;
                const cloudHasData = cloudContent && cloudContent.records && cloudContent.records.length > 0;
                if (localHasData && cloudHasData) {
                    pendingCloudData = cloudContent; ghToken = token; appState.githubConfig.gistId = targetGistId;
                    localStorage.setItem('acc_gh_token', token); utils.save();
                    document.getElementById('cloudModal').classList.remove('show');
                    document.getElementById('conflictModal').classList.add('show');
                } else {
                    if (cloudHasData) { appState.records = cloudContent.records; appState.categories = cloudContent.categories; appState.accountBooks = cloudContent.accountBooks; }
                    ghToken = token; appState.githubConfig.gistId = targetGistId;
                    localStorage.setItem('acc_gh_token', token); utils.save();
                    if (localHasData && !cloudHasData) await updateGist(token, targetGistId, appState);
                    location.reload();
                }
            } catch (error) { statusDiv.textContent = 'âŒ å¤±æ•—: ' + error.message; }
            finally { btn.disabled = false; btn.textContent = 'é€£ç·šä¸¦åŒæ­¥'; }
        }
        async function resolveConflict(action) {
            if (action === 'overwrite_local') { appState.records = pendingCloudData.records; appState.categories = pendingCloudData.categories; appState.accountBooks = pendingCloudData.accountBooks; }
            else if (action === 'overwrite_cloud') { await updateGist(ghToken, appState.githubConfig.gistId, appState); }
            else if (action === 'merge') {
                const localMap = new Map(appState.records.map(r => [r.id, r]));
                (pendingCloudData.records || []).forEach(cr => {
                    if (localMap.has(cr.id)) { if (new Date(cr.updatedAt) > new Date(localMap.get(cr.id).updatedAt)) localMap.set(cr.id, cr); }
                    else localMap.set(cr.id, cr);
                });
                appState.records = Array.from(localMap.values());
            }
            utils.save(); location.reload();
        }
        function openCloudSettings() { document.getElementById('ghToken').value = ghToken; document.getElementById('ghGistId').value = appState.githubConfig.gistId; document.getElementById('cloudModal').classList.add('show'); }
        function handleDisconnectCloud() { ghToken = ''; appState.githubConfig.gistId = ''; localStorage.removeItem('acc_gh_token'); utils.save(); location.reload(); }
        function updateCloudIconStatus() { const icon = document.getElementById('cloudSyncBtn'); icon.className = (ghToken && appState.githubConfig.gistId) ? 'cloud-icon cloud-status-on' : 'cloud-icon cloud-status-off'; }

        document.getElementById('exportDataBtn').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(appState)], {type: "application/json"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${utils.getToday()}.json`; a.click();
        });
        document.getElementById('importFile').addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const r = new FileReader();
            r.onload = (evt) => {
                try {
                    const d = JSON.parse(evt.target.result);
                    if (confirm('ç¢ºå®šåŒ¯å…¥ä¸¦è¦†è“‹ï¼Ÿ')) { Object.assign(appState, d); utils.save(); location.reload(); }
                } catch(err) { alert('æ ¼å¼éŒ¯èª¤'); }
            }; r.readAsText(file);
        });
        document.getElementById('clearAllDataBtn').addEventListener('click', () => { if(confirm('è­¦å‘Šï¼šç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) { localStorage.clear(); location.reload(); } });

        initApp();
    </script>
</body>
</html>
