<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a6fa5">
    <title>æ™ºèƒ½è¨˜å¸³ç¨‹å¼</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .date-display {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background-color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--box-shadow);
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-btn:hover {
            transform: translateY(-2px);
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
            white-space: nowrap;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--accent-color);
        }

        .btn-danger:hover {
            background-color: #ff5252;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .photo-area {
            border: 2px dashed #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            position: relative;
            background-color: #fafafa;
            transition: var(--transition);
        }

        .photo-area.has-image {
            border-style: solid;
            border-color: var(--primary-color);
            background-color: white;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            cursor: pointer;
            transition: var(--transition);
        }

        .photo-preview:hover {
            transform: scale(1.02);
        }

        .photo-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none !important;
        }

        .list-container {
            margin-top: 20px;
        }

        /* è¨˜éŒ„åˆ—è¡¨ç¯©é¸å™¨æ¨£å¼ */
        .filter-section {
            background: #f0f4f8;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border: 1px solid #d0d8e0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-grid .form-group {
            margin: 0;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .record-list {
            display: grid;
            gap: 15px;
        }

        .record-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }

        .record-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .record-card.income {
            border-left-color: var(--success-color);
        }

        .record-card.expense {
            border-left-color: var(--accent-color);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .record-date {
            font-weight: 600;
            color: var(--primary-color);
        }

        .record-amount {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .record-amount.income {
            color: var(--success-color);
        }

        .record-amount.expense {
            color: var(--accent-color);
        }

        .record-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }

        .record-summary {
            font-style: italic;
            color: #555;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }

        .record-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .record-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }

        .empty-state p {
            margin-top: 10px;
        }

        .management-list {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }

        .management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        /* çµ±è¨ˆåˆ†æå°ˆç”¨æ¨£å¼ */
        .summary-filter-section {
            background: #f0f4f8;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #d0d8e0;
        }

        .summary-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .summary-filter-grid .form-group {
            margin: 0;
        }

        .summary-filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }

        .summary-card h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .summary-item {
            text-align: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }

        .summary-value {
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 5px;
        }

        .income-text {
            color: var(--success-color);
        }

        .expense-text {
            color: var(--accent-color);
        }

        .period-summary {
            background: linear-gradient(135deg, #e3f2fd, #f5f5f5);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid #bbdefb;
        }

        .period-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        /* åŒ¯å…¥/åŒ¯å‡ºå°ˆç”¨æ¨£å¼ */
        .import-export-section {
            background: #f0f4f8;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #d0d8e0;
        }

        .export-section, .import-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid #e0e0e0;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-preview {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .import-preview h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .import-preview .data-summary {
            font-size: 0.9rem;
            line-height: 1.8;
            color: #856404;
        }

        .import-mode-selector {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .radio-label input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .file-input-label:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .file-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        .file-info.error {
            color: var(--accent-color);
            font-weight: 600;
        }

        .file-info.success {
            color: var(--success-color);
            font-weight: 600;
        }

        .export-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: var(--border-radius);
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #0066cc;
        }

        .export-info strong {
            color: #004085;
        }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: var(--success-color);
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 10000;
            transform: translateX(200%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background-color: var(--accent-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
            color: #333;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .summary-filter-grid {
                grid-template-columns: 1fr;
            }

            .record-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .record-actions {
                width: 100%;
                justify-content: stretch;
            }

            .record-actions button {
                flex: 1;
            }

            .modal-content {
                margin: 10px;
                padding: 20px;
            }

            .import-mode-selector {
                flex-direction: column;
                gap: 8px;
            }

            .export-buttons {
                flex-direction: column;
            }

            .export-buttons .btn {
                width: 100%;
            }
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .export-buttons .btn {
            flex: 1;
            min-width: 150px;
        }

        .copy-textarea {
            width: 100%;
            height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 10px;
            margin-top: 10px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>ğŸ’° æ™ºèƒ½è¨˜å¸³ç¨‹å¼</h1>
                    <div class="date-display" id="currentDate"></div>
                </div>
                <div id="totalSummary" style="font-weight: bold; font-size: 1.2rem;"></div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="record">ğŸ“ è¨˜å¸³</button>
            <button class="tab-btn" data-tab="records">ğŸ“‹ è¨˜éŒ„åˆ—è¡¨</button>
            <button class="tab-btn" data-tab="categories">ğŸ“š ç§‘ç›®ç®¡ç†</button>
            <button class="tab-btn" data-tab="locations">ğŸ“ åœ°é»ç®¡ç†</button>
            <button class="tab-btn" data-tab="summary">ğŸ“Š çµ±è¨ˆåˆ†æ</button>
            <button class="tab-btn" data-tab="import-export">âš™ï¸ åŒ¯å…¥/åŒ¯å‡º</button>
        </div>

        <!-- è¨˜å¸³è¡¨å–® -->
        <div class="tab-content active" id="record-tab">
            <form id="recordForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="recordDate">æ—¥æœŸ</label>
                        <input type="date" id="recordDate" required>
                    </div>
                    <div class="form-group">
                        <label for="recordTime">æ™‚é–“</label>
                        <input type="time" id="recordTime" required>
                    </div>
                    <div class="form-group">
                        <label for="recordType">æ”¶æ”¯åˆ¥</label>
                        <select id="recordType" required>
                            <option value="">è«‹é¸æ“‡</option>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordCategory">ç§‘ç›®</label>
                        <select id="recordCategory" required>
                            <option value="">è«‹é¸æ“‡æˆ–æ–°å¢</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordLocation">åœ°é»</label>
                        <select id="recordLocation" required>
                            <option value="">è«‹é¸æ“‡æˆ–æ–°å¢</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordAmount">é‡‘é¡</label>
                        <input type="number" id="recordAmount" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="recordSummary">æ”¶æ”¯æ‘˜è¦</label>
                    <textarea id="recordSummary" placeholder="è«‹è¼¸å…¥æ”¶æ”¯æ‘˜è¦èªªæ˜..."></textarea>
                </div>

                <!-- æ”¶æ“šæ‹ç…§/ä¸Šå‚³å€åŸŸ -->
                <div class="photo-area" id="photoArea">
                    <div id="photoPrompt">
                        <p>ğŸ“¸ é»æ“ŠæŒ‰éˆ•æ‹ç…§æˆ–ä¸Šå‚³æ”¶æ“šåœ–ç‰‡</p>
                    </div>
                    <div id="photoPreviewContainer" class="hidden">
                        <img id="photoPreview" class="photo-preview" alt="æ”¶æ“šé è¦½" title="é»æ“ŠæŸ¥çœ‹å¤§åœ–">
                    </div>
                    <div class="photo-controls">
                        <button type="button" class="btn" id="takePhotoBtn">ğŸ“· æ‹ç…§</button>
                        <button type="button" class="btn" id="uploadPhotoBtn">ğŸ“ ä¸Šå‚³åœ–ç‰‡</button>
                        <input type="file" id="photoFileInput" accept="image/*" capture="camera" class="hidden">
                        <button type="button" class="btn btn-danger hidden" id="removePhotoBtn">ğŸ—‘ï¸ åˆªé™¤åœ–ç‰‡</button>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-success">ğŸ’¾ ä¿å­˜è¨˜éŒ„</button>
                    <button type="button" class="btn" id="resetFormBtn">ğŸ”„ é‡ç½®è¡¨å–®</button>
                </div>
            </form>
        </div>

        <!-- è¨˜éŒ„åˆ—è¡¨ -->
        <div class="tab-content" id="records-tab">
            <div class="filter-section">
                <h3>ğŸ” ç¯©é¸æ¢ä»¶</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label for="filterYear">å¹´ä»½</label>
                        <select id="filterYear">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterMonth">æœˆä»½</label>
                        <select id="filterMonth">
                            <option value="">å…¨éƒ¨</option>
                            <option value="01">1æœˆ</option>
                            <option value="02">2æœˆ</option>
                            <option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option>
                            <option value="05">5æœˆ</option>
                            <option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option>
                            <option value="08">8æœˆ</option>
                            <option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterSummary">æ‘˜è¦æœå°‹</label>
                        <input type="text" id="filterSummary" placeholder="è¼¸å…¥é—œéµå­—...">
                    </div>
                    <div class="form-group">
                        <label for="filterType">æ”¶æ”¯åˆ¥</label>
                        <select id="filterType">
                            <option value="">å…¨éƒ¨</option>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterCategory">ç§‘ç›®</label>
                        <select id="filterCategory">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterLocation">åœ°é»</label>
                        <select id="filterLocation">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn" id="applyFilterBtn">ğŸ” é–‹å§‹ç¯©é¸</button>
                    <button class="btn btn-danger" id="clearFilterBtn">âœ–ï¸ æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>

            <div id="recordsList" class="record-list"></div>
        </div>

        <!-- ç§‘ç›®ç®¡ç† -->
        <div class="tab-content" id="categories-tab">
            <div class="form-group">
                <label for="newCategory">æ–°å¢ç§‘ç›®</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newCategory" placeholder="è¼¸å…¥æ–°ç§‘ç›®åç¨±">
                    <button class="btn btn-success" id="addCategoryBtn">æ–°å¢</button>
                </div>
            </div>
            <div class="management-list" id="categoriesList"></div>
        </div>

        <!-- åœ°é»ç®¡ç† -->
        <div class="tab-content" id="locations-tab">
            <div class="form-group">
                <label for="newLocation">æ–°å¢åœ°é»</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newLocation" placeholder="è¼¸å…¥æ–°åœ°é»åç¨±">
                    <button class="btn btn-success" id="addLocationBtn">æ–°å¢</button>
                </div>
            </div>
            <div class="management-list" id="locationsList"></div>
        </div>

        <!-- çµ±è¨ˆåˆ†æ -->
        <div class="tab-content" id="summary-tab">
            <!-- å¹´/æœˆç¯©é¸å™¨ -->
            <div class="summary-filter-section">
                <h3>ğŸ” ç¯©é¸æ¢ä»¶</h3>
                <div class="summary-filter-grid">
                    <div class="form-group">
                        <label for="summaryYear">å¹´ä»½</label>
                        <select id="summaryYear">
                            <option value="">å…¨éƒ¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="summaryMonth">æœˆä»½</label>
                        <select id="summaryMonth">
                            <option value="">å…¨éƒ¨</option>
                            <option value="01">1æœˆ</option>
                            <option value="02">2æœˆ</option>
                            <option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option>
                            <option value="05">5æœˆ</option>
                            <option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option>
                            <option value="08">8æœˆ</option>
                            <option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                </div>
                <div class="summary-filter-actions">
                    <button class="btn" id="applySummaryFilterBtn">ğŸ“Š ç”Ÿæˆçµ±è¨ˆ</button>
                    <button class="btn btn-danger" id="clearSummaryFilterBtn">âœ–ï¸ æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>

            <!-- çµ±è¨ˆçµæœé¡¯ç¤ºå€åŸŸ -->
            <div id="summaryResults">
                <!-- é€±æœŸç¸½è¦½ -->
                <div id="periodSummaryContainer" class="period-summary hidden">
                    <div class="period-title" id="periodTitle"></div>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div>ç¸½æ”¶å…¥</div>
                            <div class="summary-value income-text" id="periodIncome">0</div>
                        </div>
                        <div class="summary-item">
                            <div>ç¸½æ”¯å‡º</div>
                            <div class="summary-value expense-text" id="periodExpense">0</div>
                        </div>
                        <div class="summary-item">
                            <div>æ·¨æ”¶å…¥</div>
                            <div class="summary-value" id="periodNet">0</div>
                        </div>
                    </div>
                </div>

                <!-- ç¸½è¦½ï¼ˆåƒ…åœ¨æœªç¯©é¸æ™‚é¡¯ç¤ºï¼‰ -->
                <div id="overallSummary" class="summary-card">
                    <h3>ğŸ’° æ”¶æ”¯ç¸½è¦½</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div>ç¸½æ”¶å…¥</div>
                            <div class="summary-value income-text" id="totalIncome">0</div>
                        </div>
                        <div class="summary-item">
                            <div>ç¸½æ”¯å‡º</div>
                            <div class="summary-value expense-text" id="totalExpense">0</div>
                        </div>
                        <div class="summary-item">
                            <div>æ·¨æ”¶å…¥</div>
                            <div class="summary-value" id="netIncome">0</div>
                        </div>
                    </div>
                </div>

                <!-- ç§‘ç›®çµ±è¨ˆ -->
                <div class="summary-card">
                    <h3>ğŸ“Š ç§‘ç›®çµ±è¨ˆ</h3>
                    <div id="categorySummary"></div>
                </div>

                <!-- åœ°é»çµ±è¨ˆ -->
                <div class="summary-card">
                    <h3>ğŸ“ åœ°é»çµ±è¨ˆ</h3>
                    <div id="locationSummary"></div>
                </div>
            </div>
        </div>

        <!-- åŒ¯å…¥/åŒ¯å‡º -->
        <div class="tab-content" id="import-export-tab">
            <div class="import-export-section">
                <!-- åŒ¯å‡ºåŠŸèƒ½ -->
                <div class="export-section">
                    <div class="section-title">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</div>
                    <p>å°‡æ‰€æœ‰è¨˜å¸³è³‡æ–™ã€ç§‘ç›®ã€åœ°é»åŒ¯å‡ºç‚º JSON æª”æ¡ˆï¼Œç”¨æ–¼å‚™ä»½æˆ–è½‰ç§»è³‡æ–™ã€‚</p>
                    <div class="export-info">
                        <strong>ğŸ’¡ åŒ¯å‡ºæ–¹å¼èªªæ˜ï¼š</strong><br>
                        â€¢ ç¾ä»£ç€è¦½å™¨ï¼ˆChrome/Edgeï¼‰ï¼šå¯é¸æ“‡å„²å­˜è·¯å¾‘å’Œæª”å<br>
                        â€¢ å…¶ä»–ç€è¦½å™¨ï¼šæœƒä¸‹è¼‰åˆ°é è¨­ä¸‹è¼‰è³‡æ–™å¤¾<br>
                        â€¢ è¤‡è£½æ–¹å¼ï¼šå¯ç›´æ¥è¤‡è£½ JSON å…§å®¹
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-success" id="exportBtn">ğŸ“¥ é¸æ“‡è·¯å¾‘åŒ¯å‡º</button>
                        <button class="btn btn-warning" id="copyJsonBtn">ğŸ“‹ è¤‡è£½ JSON</button>
                    </div>
                    <div id="copyJsonArea" class="hidden">
                        <textarea id="jsonContent" class="copy-textarea" readonly></textarea>
                        <div class="btn-group">
                            <button class="btn btn-success" id="copyToClipboardBtn">âœ… è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
                            <button class="btn" id="closeCopyAreaBtn">é—œé–‰</button>
                        </div>
                    </div>
                </div>

                <!-- åŒ¯å…¥åŠŸèƒ½ -->
                <div class="import-section">
                    <div class="section-title">ğŸ“¥ åŒ¯å…¥è³‡æ–™</div>
                    <p>å¾ JSON æª”æ¡ˆåŒ¯å…¥è³‡æ–™ã€‚è«‹é¸æ“‡åŒ¯å…¥æ¨¡å¼ï¼š</p>
                    
                    <div class="import-mode-selector">
                        <label class="radio-label">
                            <input type="radio" name="importMode" value="merge" checked>
                            <span>åˆä½µæ¨¡å¼ï¼ˆæ–°å¢ä¸é‡è¤‡çš„è³‡æ–™ï¼‰</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="importMode" value="overwrite">
                            <span>è¦†è“‹æ¨¡å¼ï¼ˆå®Œå…¨å–ä»£ç¾æœ‰è³‡æ–™ï¼‰</span>
                        </label>
                    </div>

                    <div class="btn-group">
                        <div class="file-input-wrapper">
                            <label for="importFileInput" class="file-input-label">ğŸ“ é¸æ“‡æª”æ¡ˆ</label>
                            <input type="file" id="importFileInput" accept=".json,application/json">
                        </div>
                        <button class="btn btn-warning hidden" id="confirmImportBtn">âš ï¸ ç¢ºèªåŒ¯å…¥</button>
                    </div>

                    <div id="fileInfo" class="file-info"></div>
                    <div id="importPreview" class="import-preview hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆªé™¤ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="deleteModal" class="modal hidden" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¢ºèªåˆªé™¤</h3>
                <button class="modal-close" id="closeDeleteModal">&times;</button>
            </div>
            <p id="deleteModalMessage">æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ</p>
            <div class="btn-group">
                <button class="btn btn-danger" id="confirmDeleteBtn">ç¢ºå®šåˆªé™¤</button>
                <button class="btn" id="cancelDeleteBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ”¶æ“šæ¨¡æ…‹æ¡† -->
    <div id="receiptModal" class="modal hidden" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ”¶æ“šåœ–ç‰‡</h3>
                <button class="modal-close" id="closeReceiptModal" type="button">&times;</button>
            </div>
            <div style="text-align: center; padding: 10px;">
                <img id="receiptImage" style="max-width: 100%; max-height: 70vh; border-radius: var(--border-radius); display: block; margin: 0 auto;" alt="æ”¶æ“šåœ–ç‰‡">
            </div>
        </div>
    </div>

    <!-- åŒ¯å…¥ç¢ºèªæ¨¡æ…‹æ¡† -->
    <div id="importConfirmModal" class="modal hidden" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>âš ï¸ åŒ¯å…¥ç¢ºèª</h3>
                <button class="modal-close" id="closeImportConfirmModal">&times;</button>
            </div>
            <div id="importConfirmMessage"></div>
            <div class="btn-group">
                <button class="btn btn-warning" id="finalImportBtn">âš ï¸ ç¢ºå®šåŒ¯å…¥</button>
                <button class="btn" id="cancelImportBtn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æç¤º -->
    <div id="notification" class="notification"></div>

    <script>
        // æ•¸æ“šå­˜å„²
        const storage = {
            get: (key, defaultValue = []) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : defaultValue;
                } catch (e) {
                    console.error(`Error retrieving ${key} from localStorage:`, e);
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error(`Error saving ${key} to localStorage:`, e);
                    return false;
                }
            }
        };

        // æ‡‰ç”¨ç‹€æ…‹
        const appState = {
            records: storage.get('records', []),
            categories: storage.get('categories', ['é¤é£²', 'äº¤é€š', 'å¨›æ¨‚', 'ç”Ÿæ´»', 'æ”¶å…¥', 'å…¶ä»–']),
            locations: storage.get('locations', ['å®¶ä¸­', 'å…¬å¸', 'å•†åº—', 'é¤å»³', 'å…¶ä»–']),
            currentPhoto: null,
            deleteTargetId: null,
            currentViewingRecordId: null,
            summaryFilter: {
                year: '',
                month: ''
            },
            importData: null, // æš«å­˜åŒ¯å…¥çš„è³‡æ–™
            importMode: 'merge' // é è¨­åˆä½µæ¨¡å¼
        };

        // DOM å…ƒç´ 
        const elements = {
            // è¡¨å–®å…ƒç´ 
            recordForm: document.getElementById('recordForm'),
            recordDate: document.getElementById('recordDate'),
            recordTime: document.getElementById('recordTime'),
            recordType: document.getElementById('recordType'),
            recordCategory: document.getElementById('recordCategory'),
            recordLocation: document.getElementById('recordLocation'),
            recordAmount: document.getElementById('recordAmount'),
            recordSummary: document.getElementById('recordSummary'),
            
            // ç…§ç‰‡ç›¸é—œ
            photoArea: document.getElementById('photoArea'),
            photoPrompt: document.getElementById('photoPrompt'),
            photoPreviewContainer: document.getElementById('photoPreviewContainer'),
            photoPreview: document.getElementById('photoPreview'),
            takePhotoBtn: document.getElementById('takePhotoBtn'),
            uploadPhotoBtn: document.getElementById('uploadPhotoBtn'),
            photoFileInput: document.getElementById('photoFileInput'),
            removePhotoBtn: document.getElementById('removePhotoBtn'),
            
            // æŒ‰éˆ•
            resetFormBtn: document.getElementById('resetFormBtn'),
            addCategoryBtn: document.getElementById('addCategoryBtn'),
            addLocationBtn: document.getElementById('addLocationBtn'),
            applyFilterBtn: document.getElementById('applyFilterBtn'),
            clearFilterBtn: document.getElementById('clearFilterBtn'),
            
            // é¸é …è¼¸å…¥
            newCategory: document.getElementById('newCategory'),
            newLocation: document.getElementById('newLocation'),
            
            // è¨˜éŒ„åˆ—è¡¨ç¯©é¸å™¨
            filterYear: document.getElementById('filterYear'),
            filterMonth: document.getElementById('filterMonth'),
            filterSummary: document.getElementById('filterSummary'),
            filterType: document.getElementById('filterType'),
            filterCategory: document.getElementById('filterCategory'),
            filterLocation: document.getElementById('filterLocation'),
            
            // åˆ—è¡¨å®¹å™¨
            recordsList: document.getElementById('recordsList'),
            categoriesList: document.getElementById('categoriesList'),
            locationsList: document.getElementById('locationsList'),
            
            // æ¨™ç±¤æŒ‰éˆ•
            tabBtns: document.querySelectorAll('.tab-btn'),
            
            // çµ±è¨ˆå…ƒç´ 
            summaryYear: document.getElementById('summaryYear'),
            summaryMonth: document.getElementById('summaryMonth'),
            applySummaryFilterBtn: document.getElementById('applySummaryFilterBtn'),
            clearSummaryFilterBtn: document.getElementById('clearSummaryFilterBtn'),
            
            // çµ±è¨ˆçµæœå®¹å™¨
            periodSummaryContainer: document.getElementById('periodSummaryContainer'),
            periodTitle: document.getElementById('periodTitle'),
            periodIncome: document.getElementById('periodIncome'),
            periodExpense: document.getElementById('periodExpense'),
            periodNet: document.getElementById('periodNet'),
            
            overallSummary: document.getElementById('overallSummary'),
            totalIncome: document.getElementById('totalIncome'),
            totalExpense: document.getElementById('totalExpense'),
            netIncome: document.getElementById('netIncome'),
            categorySummary: document.getElementById('categorySummary'),
            locationSummary: document.getElementById('locationSummary'),
            totalSummary: document.getElementById('totalSummary'),
            
            // åŒ¯å…¥/åŒ¯å‡ºå…ƒç´ 
            exportBtn: document.getElementById('exportBtn'),
            copyJsonBtn: document.getElementById('copyJsonBtn'),
            copyJsonArea: document.getElementById('copyJsonArea'),
            jsonContent: document.getElementById('jsonContent'),
            copyToClipboardBtn: document.getElementById('copyToClipboardBtn'),
            closeCopyAreaBtn: document.getElementById('closeCopyAreaBtn'),
            
            importFileInput: document.getElementById('importFileInput'),
            confirmImportBtn: document.getElementById('confirmImportBtn'),
            fileInfo: document.getElementById('fileInfo'),
            importPreview: document.getElementById('importPreview'),
            
            // æ¨¡æ…‹æ¡†
            deleteModal: document.getElementById('deleteModal'),
            closeDeleteModal: document.getElementById('closeDeleteModal'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
            deleteModalMessage: document.getElementById('deleteModalMessage'),
            
            receiptModal: document.getElementById('receiptModal'),
            closeReceiptModal: document.getElementById('closeReceiptModal'),
            receiptImage: document.getElementById('receiptImage'),
            
            importConfirmModal: document.getElementById('importConfirmModal'),
            closeImportConfirmModal: document.getElementById('closeImportConfirmModal'),
            importConfirmMessage: document.getElementById('importConfirmMessage'),
            finalImportBtn: document.getElementById('finalImportBtn'),
            cancelImportBtn: document.getElementById('cancelImportBtn'),
            
            // é€šçŸ¥
            notification: document.getElementById('notification'),
            
            // æ—¥æœŸé¡¯ç¤º
            currentDate: document.getElementById('currentDate')
        };

        // å·¥å…·å‡½æ•¸
        const utils = {
            // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“
            formatDateTime: (dateStr, timeStr) => {
                const date = new Date(`${dateStr}T${timeStr}`);
                return date.toLocaleString('zh-TW');
            },
            
            // æ ¼å¼åŒ–é‡‘é¡
            formatAmount: (amount) => {
                return parseFloat(amount).toLocaleString('zh-TW', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            },
            
            // ç”Ÿæˆå”¯ä¸€ID
            generateId: () => {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            },
            
            // é¡¯ç¤ºé€šçŸ¥
            showNotification: (message, isError = false, isWarning = false) => {
                elements.notification.textContent = message;
                elements.notification.className = `notification ${isError ? 'error' : ''} ${isWarning ? 'warning' : ''}`;
                elements.notification.classList.add('show');
                
                setTimeout(() => {
                    elements.notification.classList.remove('show');
                }, 3000);
            },
            
            // ç²å–ç•¶å‰æ—¥æœŸæ™‚é–“ä¸¦è¨­ç½®åˆ°è¡¨å–®
            setCurrentDateTime: () => {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].substr(0, 5);
                
                elements.recordDate.value = dateStr;
                elements.recordTime.value = timeStr;
                
                // æ›´æ–°é ‚éƒ¨æ—¥æœŸé¡¯ç¤º
                elements.currentDate.textContent = now.toLocaleDateString('zh-TW', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            },
            
            // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
            calculateSummary: (records) => {
                const summary = {
                    totalIncome: 0,
                    totalExpense: 0,
                    netIncome: 0,
                    byCategory: {},
                    byLocation: {}
                };
                
                records.forEach(record => {
                    const amount = parseFloat(record.amount);
                    
                    if (record.type === 'income') {
                        summary.totalIncome += amount;
                    } else {
                        summary.totalExpense += amount;
                    }
                    
                    // ç§‘ç›®çµ±è¨ˆ
                    if (!summary.byCategory[record.category]) {
                        summary.byCategory[record.category] = { income: 0, expense: 0 };
                    }
                    if (record.type === 'income') {
                        summary.byCategory[record.category].income += amount;
                    } else {
                        summary.byCategory[record.category].expense += amount;
                    }
                    
                    // åœ°é»çµ±è¨ˆ
                    if (!summary.byLocation[record.location]) {
                        summary.byLocation[record.location] = { income: 0, expense: 0 };
                    }
                    if (record.type === 'income') {
                        summary.byLocation[record.location].income += amount;
                    } else {
                        summary.byLocation[record.location].expense += amount;
                    }
                });
                
                summary.netIncome = summary.totalIncome - summary.totalExpense;
                
                return summary;
            },
            
            // åœ–ç‰‡è™•ç†
            processImage: (file) => {
                return new Promise((resolve, reject) => {
                    if (!file.type.match('image.*')) {
                        reject(new Error('è«‹é¸æ“‡åœ–ç‰‡æ–‡ä»¶'));
                        return;
                    }
                    
                    // æª¢æŸ¥æ–‡ä»¶å¤§å° (é™åˆ¶ 2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        reject(new Error('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 2MB'));
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve(e.target.result);
                    };
                    reader.onerror = (error) => {
                        reject(error);
                    };
                    reader.readAsDataURL(file);
                });
            },
            
            // å¾æ—¥æœŸæå–å¹´ä»½å’Œæœˆä»½
            extractYearMonth: (dateStr) => {
                const date = new Date(dateStr);
                return {
                    year: date.getFullYear().toString(),
                    month: (date.getMonth() + 1).toString().padStart(2, '0')
                };
            },
            
            // ç²å–æ‰€æœ‰å¹´ä»½ï¼ˆç”¨æ–¼å¹´ä»½é¸æ“‡å™¨ï¼‰
            getAllYears: () => {
                const years = new Set();
                appState.records.forEach(record => {
                    const { year } = utils.extractYearMonth(record.date);
                    years.add(year);
                });
                return Array.from(years).sort((a, b) => b - a); // é™åºæ’åˆ—
            },
            
            // é©—è­‰åŒ¯å…¥è³‡æ–™æ ¼å¼
            validateImportData: (data) => {
                if (!data || typeof data !== 'object') {
                    return { valid: false, error: 'æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º' };
                }
                
                if (!Array.isArray(data.records) || !Array.isArray(data.categories) || !Array.isArray(data.locations)) {
                    return { valid: false, error: 'ç¼ºå°‘å¿…è¦çš„è³‡æ–™çµæ§‹ (records, categories, locations)' };
                }
                
                // é©—è­‰æ¯ç­†è¨˜éŒ„çš„åŸºæœ¬çµæ§‹
                for (let i = 0; i < data.records.length; i++) {
                    const record = data.records[i];
                    if (!record.date || !record.time || !record.type || !record.category || !record.location || !record.amount) {
                        return { valid: false, error: `ç¬¬ ${i + 1} ç­†è¨˜éŒ„ç¼ºå°‘å¿…è¦æ¬„ä½` };
                    }
                }
                
                return { valid: true, data: data };
            },
            
            // æª”æ¡ˆå¤§å°æ ¼å¼åŒ–
            formatFileSize: (bytes) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        };

        // æ‡‰ç”¨åŠŸèƒ½
        const app = {
            // åˆå§‹åŒ–
            init: () => {
                utils.setCurrentDateTime();
                app.updateAllSelects();
                app.renderCategoriesList();
                app.renderLocationsList();
                app.renderRecordsList();
                app.updateSummary();
                app.setupEventListeners();
                app.updateYearSelector();
                
                // ç¢ºä¿æ‰€æœ‰æ¨¡æ…‹æ¡†åˆå§‹éš±è—
                app.hideAllModals();
            },
            
            // éš±è—æ‰€æœ‰æ¨¡æ…‹æ¡†
            hideAllModals: () => {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                });
            },
            
            // æ›´æ–°æ‰€æœ‰é¸æ“‡ä¸‹æ‹‰èœå–®
            updateAllSelects: () => {
                // æ›´æ–°ç§‘ç›®é¸æ“‡
                elements.recordCategory.innerHTML = '<option value="">è«‹é¸æ“‡æˆ–æ–°å¢</option>';
                appState.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    elements.recordCategory.appendChild(option);
                });
                
                // æ›´æ–°åœ°é»é¸æ“‡
                elements.recordLocation.innerHTML = '<option value="">è«‹é¸æ“‡æˆ–æ–°å¢</option>';
                appState.locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    elements.recordLocation.appendChild(option);
                });
                
                // æ›´æ–°éæ¿¾å™¨é¸æ“‡ - è¨˜éŒ„åˆ—è¡¨
                elements.filterCategory.innerHTML = '<option value="">å…¨éƒ¨</option>';
                appState.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    elements.filterCategory.appendChild(option);
                });
                
                elements.filterLocation.innerHTML = '<option value="">å…¨éƒ¨</option>';
                appState.locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    elements.filterLocation.appendChild(option);
                });
                
                // æ›´æ–°å¹´ä»½é¸æ“‡å™¨ - è¨˜éŒ„åˆ—è¡¨
                app.updateRecordListYearSelector();
            },
            
            // æ›´æ–°è¨˜éŒ„åˆ—è¡¨çš„å¹´ä»½é¸æ“‡å™¨
            updateRecordListYearSelector: () => {
                const years = utils.getAllYears();
                elements.filterYear.innerHTML = '<option value="">å…¨éƒ¨</option>';
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 'å¹´';
                    elements.filterYear.appendChild(option);
                });
            },
            
            // æ›´æ–°çµ±è¨ˆåˆ†æçš„å¹´ä»½é¸æ“‡å™¨
            updateYearSelector: () => {
                const years = utils.getAllYears();
                elements.summaryYear.innerHTML = '<option value="">å…¨éƒ¨</option>';
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 'å¹´';
                    elements.summaryYear.appendChild(option);
                });
            },
            
            // ä¿å­˜æ•¸æ“šåˆ°æœ¬åœ°å­˜å„²
            saveData: () => {
                storage.set('records', appState.records);
                storage.set('categories', appState.categories);
                storage.set('locations', appState.locations);
            },
            
            // æ–°å¢è¨˜éŒ„
            addRecord: (recordData) => {
                const newRecord = {
                    id: utils.generateId(),
                    ...recordData,
                    createdAt: new Date().toISOString()
                };
                
                appState.records.unshift(newRecord);
                app.saveData();
                app.renderRecordsList();
                app.updateSummary();
                app.updateRecordListYearSelector(); // æ›´æ–°è¨˜éŒ„åˆ—è¡¨å¹´ä»½é¸æ“‡å™¨
                app.updateYearSelector(); // æ›´æ–°çµ±è¨ˆåˆ†æå¹´ä»½é¸æ“‡å™¨
                utils.showNotification('è¨˜éŒ„å·²ä¿å­˜ï¼');
            },
            
            // åˆªé™¤è¨˜éŒ„
            deleteRecord: (id) => {
                appState.records = appState.records.filter(record => record.id !== id);
                app.saveData();
                app.renderRecordsList();
                app.updateSummary();
                app.updateRecordListYearSelector(); // æ›´æ–°è¨˜éŒ„åˆ—è¡¨å¹´ä»½é¸æ“‡å™¨
                app.updateYearSelector(); // æ›´æ–°çµ±è¨ˆåˆ†æå¹´ä»½é¸æ“‡å™¨
                utils.showNotification('è¨˜éŒ„å·²åˆªé™¤ï¼');
            },
            
            // æ–°å¢ç§‘ç›®
            addCategory: (name) => {
                if (!name.trim()) {
                    utils.showNotification('è«‹è¼¸å…¥ç§‘ç›®åç¨±', true);
                    return;
                }
                
                if (appState.categories.includes(name)) {
                    utils.showNotification('è©²ç§‘ç›®å·²å­˜åœ¨', true);
                    return;
                }
                
                appState.categories.push(name);
                app.saveData();
                app.updateAllSelects();
                app.renderCategoriesList();
                utils.showNotification('ç§‘ç›®å·²æ–°å¢ï¼');
                elements.newCategory.value = '';
            },
            
            // åˆªé™¤ç§‘ç›®
            deleteCategory: (name) => {
                // æª¢æŸ¥æ˜¯å¦æœ‰è¨˜éŒ„ä½¿ç”¨è©²ç§‘ç›®
                const hasRecords = appState.records.some(record => record.category === name);
                if (hasRecords) {
                    utils.showNotification('ç„¡æ³•åˆªé™¤ï¼Œå·²æœ‰è¨˜éŒ„ä½¿ç”¨è©²ç§‘ç›®', true);
                    return;
                }
                
                appState.categories = appState.categories.filter(cat => cat !== name);
                app.saveData();
                app.updateAllSelects();
                app.renderCategoriesList();
                utils.showNotification('ç§‘ç›®å·²åˆªé™¤ï¼');
            },
            
            // æ–°å¢åœ°é»
            addLocation: (name) => {
                if (!name.trim()) {
                    utils.showNotification('è«‹è¼¸å…¥åœ°é»åç¨±', true);
                    return;
                }
                
                if (appState.locations.includes(name)) {
                    utils.showNotification('è©²åœ°é»å·²å­˜åœ¨', true);
                    return;
                }
                
                appState.locations.push(name);
                app.saveData();
                app.updateAllSelects();
                app.renderLocationsList();
                utils.showNotification('åœ°é»å·²æ–°å¢ï¼');
                elements.newLocation.value = '';
            },
            
            // åˆªé™¤åœ°é»
            deleteLocation: (name) => {
                // æª¢æŸ¥æ˜¯å¦æœ‰è¨˜éŒ„ä½¿ç”¨è©²åœ°é»
                const hasRecords = appState.records.some(record => record.location === name);
                if (hasRecords) {
                    utils.showNotification('ç„¡æ³•åˆªé™¤ï¼Œå·²æœ‰è¨˜éŒ„ä½¿ç”¨è©²åœ°é»', true);
                    return;
                }
                
                appState.locations = appState.locations.filter(loc => loc !== name);
                app.saveData();
                app.updateAllSelects();
                app.renderLocationsList();
                utils.showNotification('åœ°é»å·²åˆªé™¤ï¼');
            },
            
            // æ¸²æŸ“è¨˜éŒ„åˆ—è¡¨
            renderRecordsList: (filteredRecords = null) => {
                const records = filteredRecords || appState.records;
                const container = elements.recordsList;
                
                if (records.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>ğŸ“­ æ²’æœ‰è¨˜éŒ„</h3>
                            <p>${filteredRecords ? 'æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è¨˜éŒ„' : 'å°šæœªæ–°å¢ä»»ä½•è¨˜å¸³è¨˜éŒ„'}</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                records.forEach(record => {
                    const card = document.createElement('div');
                    card.className = `record-card ${record.type}`;
                    
                    const hasReceipt = record.receiptImage && record.receiptImage.trim() !== '';
                    
                    card.innerHTML = `
                        <div class="record-header">
                            <div class="record-date">${utils.formatDateTime(record.date, record.time)}</div>
                            <div class="record-amount ${record.type}">
                                ${record.type === 'income' ? '+' : '-'}${utils.formatAmount(record.amount)}
                            </div>
                        </div>
                        <div class="record-details">
                            <div><strong>ç§‘ç›®:</strong> ${record.category}</div>
                            <div><strong>åœ°é»:</strong> ${record.location}</div>
                            <div><strong>æ”¶æ”¯åˆ¥:</strong> ${record.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º'}</div>
                        </div>
                        ${record.summary ? `<div class="record-summary">${record.summary}</div>` : ''}
                        <div class="record-actions">
                            ${hasReceipt ? `<button class="btn" onclick="app.viewReceipt('${record.id}')">ğŸ–¼ï¸ æŸ¥çœ‹æ”¶æ“š</button>` : ''}
                            <button class="btn btn-danger" onclick="app.confirmDelete('${record.id}')">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            },
            
            // æ¸²æŸ“ç§‘ç›®åˆ—è¡¨
            renderCategoriesList: () => {
                const container = elements.categoriesList;
                container.innerHTML = '';
                
                if (appState.categories.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>å°šç„¡ç§‘ç›®ï¼Œè«‹æ–°å¢</p></div>';
                    return;
                }
                
                appState.categories.forEach(cat => {
                    const item = document.createElement('div');
                    item.className = 'management-item';
                    item.innerHTML = `
                        <span>${cat}</span>
                        <button class="btn btn-danger" onclick="app.deleteCategory('${cat}')">åˆªé™¤</button>
                    `;
                    container.appendChild(item);
                });
            },
            
            // æ¸²æŸ“åœ°é»åˆ—è¡¨
            renderLocationsList: () => {
                const container = elements.locationsList;
                container.innerHTML = '';
                
                if (appState.locations.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>å°šç„¡åœ°é»ï¼Œè«‹æ–°å¢</p></div>';
                    return;
                }
                
                appState.locations.forEach(loc => {
                    const item = document.createElement('div');
                    item.className = 'management-item';
                    item.innerHTML = `
                        <span>${loc}</span>
                        <button class="btn btn-danger" onclick="app.deleteLocation('${loc}')">åˆªé™¤</button>
                    `;
                    container.appendChild(item);
                });
            },
            
            // æ›´æ–°çµ±è¨ˆæ•¸æ“šï¼ˆç¸½è¦½ï¼‰
            updateSummary: () => {
                const summary = utils.calculateSummary(appState.records);
                
                // æ›´æ–°ç¸½è¦½
                elements.totalIncome.textContent = utils.formatAmount(summary.totalIncome);
                elements.totalExpense.textContent = utils.formatAmount(summary.totalExpense);
                elements.netIncome.textContent = utils.formatAmount(summary.netIncome);
                elements.netIncome.className = 'summary-value ' + (summary.netIncome >= 0 ? 'income-text' : 'expense-text');
                
                // æ›´æ–°ç¸½æ‘˜è¦ï¼ˆé¡¯ç¤ºåœ¨é ‚éƒ¨ï¼‰
                const netText = summary.netIncome >= 0 ? `ğŸ’° æ·¨æ”¶å…¥: ${utils.formatAmount(summary.netIncome)}` : `ğŸ’¸ æ·¨æ”¯å‡º: ${utils.formatAmount(Math.abs(summary.netIncome))}`;
                elements.totalSummary.textContent = `æ”¶å…¥: ${utils.formatAmount(summary.totalIncome)} | æ”¯å‡º: ${utils.formatAmount(summary.totalExpense)} | ${netText}`;
                
                // ç§‘ç›®çµ±è¨ˆ
                const categoryContainer = elements.categorySummary;
                if (Object.keys(summary.byCategory).length === 0) {
                    categoryContainer.innerHTML = '<div class="empty-state"><p>å°šç„¡çµ±è¨ˆæ•¸æ“š</p></div>';
                } else {
                    categoryContainer.innerHTML = '<div class="summary-grid">';
                    for (const [category, data] of Object.entries(summary.byCategory)) {
                        const total = data.income - data.expense;
                        const totalText = total >= 0 ? `+${utils.formatAmount(total)}` : `-${utils.formatAmount(Math.abs(total))}`;
                        const totalClass = total >= 0 ? 'income-text' : 'expense-text';
                        
                        categoryContainer.innerHTML += `
                            <div class="summary-item">
                                <div>${category}</div>
                                <div style="font-size: 0.8rem; color: #666;">æ”¶: ${utils.formatAmount(data.income)} | æ”¯: ${utils.formatAmount(data.expense)}</div>
                                <div class="summary-value ${totalClass}">${totalText}</div>
                            </div>
                        `;
                    }
                    categoryContainer.innerHTML += '</div>';
                }
                
                // åœ°é»çµ±è¨ˆ
                const locationContainer = elements.locationSummary;
                if (Object.keys(summary.byLocation).length === 0) {
                    locationContainer.innerHTML = '<div class="empty-state"><p>å°šç„¡çµ±è¨ˆæ•¸æ“š</p></div>';
                } else {
                    locationContainer.innerHTML = '<div class="summary-grid">';
                    for (const [location, data] of Object.entries(summary.byLocation)) {
                        const total = data.income - data.expense;
                        const totalText = total >= 0 ? `+${utils.formatAmount(total)}` : `-${utils.formatAmount(Math.abs(total))}`;
                        const totalClass = total >= 0 ? 'income-text' : 'expense-text';
                        
                        locationContainer.innerHTML += `
                            <div class="summary-item">
                                <div>${location}</div>
                                <div style="font-size: 0.8rem; color: #666;">æ”¶: ${utils.formatAmount(data.income)} | æ”¯: ${utils.formatAmount(data.expense)}</div>
                                <div class="summary-value ${totalClass}">${totalText}</div>
                            </div>
                        `;
                    }
                    locationContainer.innerHTML += '</div>';
                }
            },
            
            // æ‡‰ç”¨çµ±è¨ˆç¯©é¸
            applySummaryFilter: () => {
                const year = elements.summaryYear.value;
                const month = elements.summaryMonth.value;
                
                // ä¿å­˜ç¯©é¸æ¢ä»¶
                appState.summaryFilter.year = year;
                appState.summaryFilter.month = month;
                
                // ç¯©é¸è¨˜éŒ„
                let filtered = appState.records.filter(record => {
                    const { year: recordYear, month: recordMonth } = utils.extractYearMonth(record.date);
                    
                    if (year && recordYear !== year) return false;
                    if (month && recordMonth !== month) return false;
                    
                    return true;
                });
                
                if (filtered.length === 0) {
                    utils.showNotification('è©²æœŸé–“ç„¡ä»»ä½•è¨˜éŒ„', true);
                    app.hidePeriodSummary();
                    return;
                }
                
                // è¨ˆç®—çµ±è¨ˆ
                const summary = utils.calculateSummary(filtered);
                
                // é¡¯ç¤ºé€±æœŸç¸½è¦½
                app.showPeriodSummary(year, month, summary);
                
                // æ›´æ–°çµ±è¨ˆæ•¸æ“š
                app.updateFilteredSummary(filtered);
                
                utils.showNotification(`å·²ç”Ÿæˆ ${year || 'å…¨éƒ¨'}å¹´ ${month || 'å…¨éƒ¨'}æœˆ çš„çµ±è¨ˆ`);
            },
            
            // é¡¯ç¤ºé€±æœŸç¸½è¦½
            showPeriodSummary: (year, month, summary) => {
                let periodText = '';
                if (year && month) {
                    periodText = `${year}å¹´${parseInt(month)}æœˆ`;
                } else if (year) {
                    periodText = `${year}å¹´`;
                } else if (month) {
                    periodText = `${parseInt(month)}æœˆ`;
                } else {
                    periodText = 'å…¨éƒ¨æœŸé–“';
                }
                
                elements.periodTitle.textContent = periodText + ' æ”¶æ”¯ç¸½è¦½';
                elements.periodIncome.textContent = utils.formatAmount(summary.totalIncome);
                elements.periodExpense.textContent = utils.formatAmount(summary.totalExpense);
                elements.periodNet.textContent = utils.formatAmount(summary.netIncome);
                elements.periodNet.className = 'summary-value ' + (summary.netIncome >= 0 ? 'income-text' : 'expense-text');
                
                elements.periodSummaryContainer.classList.remove('hidden');
            },
            
            // éš±è—é€±æœŸç¸½è¦½
            hidePeriodSummary: () => {
                elements.periodSummaryContainer.classList.add('hidden');
            },
            
            // æ›´æ–°ç¯©é¸å¾Œçš„çµ±è¨ˆæ•¸æ“š
            updateFilteredSummary: (filteredRecords) => {
                const summary = utils.calculateSummary(filteredRecords);
                
                // ç§‘ç›®çµ±è¨ˆ
                const categoryContainer = elements.categorySummary;
                if (Object.keys(summary.byCategory).length === 0) {
                    categoryContainer.innerHTML = '<div class="empty-state"><p>å°šç„¡çµ±è¨ˆæ•¸æ“š</p></div>';
                } else {
                    categoryContainer.innerHTML = '<div class="summary-grid">';
                    for (const [category, data] of Object.entries(summary.byCategory)) {
                        const total = data.income - data.expense;
                        const totalText = total >= 0 ? `+${utils.formatAmount(total)}` : `-${utils.formatAmount(Math.abs(total))}`;
                        const totalClass = total >= 0 ? 'income-text' : 'expense-text';
                        
                        categoryContainer.innerHTML += `
                            <div class="summary-item">
                                <div>${category}</div>
                                <div style="font-size: 0.8rem; color: #666;">æ”¶: ${utils.formatAmount(data.income)} | æ”¯: ${utils.formatAmount(data.expense)}</div>
                                <div class="summary-value ${totalClass}">${totalText}</div>
                            </div>
                        `;
                    }
                    categoryContainer.innerHTML += '</div>';
                }
                
                // åœ°é»çµ±è¨ˆ
                const locationContainer = elements.locationSummary;
                if (Object.keys(summary.byLocation).length === 0) {
                    locationContainer.innerHTML = '<div class="empty-state"><p>å°šç„¡çµ±è¨ˆæ•¸æ“š</p></div>';
                } else {
                    locationContainer.innerHTML = '<div class="summary-grid">';
                    for (const [location, data] of Object.entries(summary.byLocation)) {
                        const total = data.income - data.expense;
                        const totalText = total >= 0 ? `+${utils.formatAmount(total)}` : `-${utils.formatAmount(Math.abs(total))}`;
                        const totalClass = total >= 0 ? 'income-text' : 'expense-text';
                        
                        locationContainer.innerHTML += `
                            <div class="summary-item">
                                <div>${location}</div>
                                <div style="font-size: 0.8rem; color: #666;">æ”¶: ${utils.formatAmount(data.income)} | æ”¯: ${utils.formatAmount(data.expense)}</div>
                                <div class="summary-value ${totalClass}">${totalText}</div>
                            </div>
                        `;
                    }
                    locationContainer.innerHTML += '</div>';
                }
            },
            
            // æ¸…é™¤çµ±è¨ˆç¯©é¸
            clearSummaryFilter: () => {
                elements.summaryYear.value = '';
                elements.summaryMonth.value = '';
                appState.summaryFilter = { year: '', month: '' };
                app.hidePeriodSummary();
                app.updateSummary(); // æ¢å¾©ç¸½è¦½
                utils.showNotification('çµ±è¨ˆç¯©é¸å·²æ¸…é™¤');
            },
            
            // æ‡‰ç”¨éæ¿¾å™¨ï¼ˆè¨˜éŒ„åˆ—è¡¨ï¼‰
            applyFilters: () => {
                const year = elements.filterYear.value;
                const month = elements.filterMonth.value;
                const summaryKeyword = elements.filterSummary.value.trim();
                const type = elements.filterType.value;
                const category = elements.filterCategory.value;
                const location = elements.filterLocation.value;
                
                let filtered = appState.records.filter(record => {
                    // å¹´ä»½éæ¿¾
                    if (year) {
                        const { year: recordYear } = utils.extractYearMonth(record.date);
                        if (recordYear !== year) return false;
                    }
                    
                    // æœˆä»½éæ¿¾
                    if (month) {
                        const { month: recordMonth } = utils.extractYearMonth(record.date);
                        if (recordMonth !== month) return false;
                    }
                    
                    // æ‘˜è¦é—œéµå­—æœå°‹ï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
                    if (summaryKeyword) {
                        if (!record.summary || !record.summary.toLowerCase().includes(summaryKeyword.toLowerCase())) {
                            return false;
                        }
                    }
                    
                    // é¡å‹éæ¿¾
                    if (type && record.type !== type) return false;
                    
                    // ç§‘ç›®éæ¿¾
                    if (category && record.category !== category) return false;
                    
                    // åœ°é»éæ¿¾
                    if (location && record.location !== location) return false;
                    
                    return true;
                });
                
                app.renderRecordsList(filtered);
                
                // é¡¯ç¤ºç¯©é¸çµæœæ•¸é‡
                if (filtered.length > 0) {
                    utils.showNotification(`æ‰¾åˆ° ${filtered.length} ç­†ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„`);
                } else {
                    utils.showNotification('æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è¨˜éŒ„', true);
                }
            },
            
            // æ¸…é™¤éæ¿¾å™¨ï¼ˆè¨˜éŒ„åˆ—è¡¨ï¼‰
            clearFilters: () => {
                elements.filterYear.value = '';
                elements.filterMonth.value = '';
                elements.filterSummary.value = '';
                elements.filterType.value = '';
                elements.filterCategory.value = '';
                elements.filterLocation.value = '';
                app.renderRecordsList();
                utils.showNotification('ç¯©é¸å™¨å·²æ¸…é™¤');
            },
            
            // ç¢ºèªåˆªé™¤
            confirmDelete: (id) => {
                appState.deleteTargetId = id;
                elements.deleteModalMessage.textContent = 'æ‚¨ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚';
                elements.deleteModal.classList.remove('hidden');
                elements.deleteModal.style.display = 'flex';
            },
            
            // æŸ¥çœ‹æ”¶æ“š
            viewReceipt: (id) => {
                const record = appState.records.find(r => r.id === id);
                if (record && record.receiptImage) {
                    elements.receiptImage.src = record.receiptImage;
                    elements.receiptModal.classList.remove('hidden');
                    elements.receiptModal.style.display = 'flex';
                    
                    // é˜²æ­¢åœ–ç‰‡é»æ“Šäº‹ä»¶å†’æ³¡
                    elements.receiptImage.onclick = (e) => {
                        e.stopPropagation();
                    };
                } else {
                    utils.showNotification('æ‰¾ä¸åˆ°æ”¶æ“šåœ–ç‰‡', true);
                }
            },
            
            // é‡ç½®è¡¨å–®
            resetForm: () => {
                elements.recordForm.reset();
                utils.setCurrentDateTime();
                appState.currentPhoto = null;
                elements.photoPreviewContainer.classList.add('hidden');
                elements.photoPrompt.classList.remove('hidden');
                elements.removePhotoBtn.classList.add('hidden');
                elements.photoArea.classList.remove('has-image');
                elements.photoFileInput.value = '';
                elements.photoPreview.onclick = null;
            },
            
            // åŒ¯å‡ºåŠŸèƒ½ï¼ˆå¢å¼·ç‰ˆï¼‰
            exportData: async () => {
                const exportData = {
                    records: appState.records,
                    categories: appState.categories,
                    locations: appState.locations,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const dateStr = new Date().toISOString().split('T')[0];
                const defaultFileName = `accounting_backup_${dateStr}.json`;
                
                // å˜—è©¦ä½¿ç”¨ showSaveFilePickerï¼ˆç¾ä»£ç€è¦½å™¨ï¼‰
                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: defaultFileName,
                            types: [{
                                description: 'JSON Files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                        
                        const writable = await handle.createWritable();
                        await writable.write(dataStr);
                        await writable.close();
                        
                        utils.showNotification('è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºï¼');
                        return;
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.warn('showSaveFilePicker å¤±æ•—ï¼Œæ”¹ç”¨å‚³çµ±æ–¹å¼:', error);
                        }
                    }
                }
                
                // å‚³çµ±ä¸‹è¼‰æ–¹å¼ï¼ˆå›é€€æ–¹æ¡ˆï¼‰
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = defaultFileName;
                link.click();
                URL.revokeObjectURL(url);
                
                utils.showNotification('è³‡æ–™å·²æˆåŠŸåŒ¯å‡ºï¼ï¼ˆè«‹æª¢æŸ¥ä¸‹è¼‰è³‡æ–™å¤¾ï¼‰');
            },
            
            // è¤‡è£½ JSON åŠŸèƒ½
            copyJsonData: () => {
                const exportData = {
                    records: appState.records,
                    categories: appState.categories,
                    locations: appState.locations,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                elements.jsonContent.value = dataStr;
                elements.copyJsonArea.classList.remove('hidden');
                elements.copyJsonArea.scrollIntoView({ behavior: 'smooth' });
                utils.showNotification('JSON å…§å®¹å·²ç”Ÿæˆï¼Œè«‹è¤‡è£½');
            },
            
            // è¤‡è£½åˆ°å‰ªè²¼ç°¿
            copyToClipboard: () => {
                const content = elements.jsonContent.value;
                if (!content) {
                    utils.showNotification('æ²’æœ‰å…§å®¹å¯è¤‡è£½', true);
                    return;
                }
                
                navigator.clipboard.writeText(content).then(() => {
                    utils.showNotification('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                }).catch(() => {
                    // é™ç´šæ–¹æ¡ˆ
                    elements.jsonContent.select();
                    document.execCommand('copy');
                    utils.showNotification('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                });
            },
            
            // é—œé–‰è¤‡è£½å€åŸŸ
            closeCopyArea: () => {
                elements.copyJsonArea.classList.add('hidden');
                elements.jsonContent.value = '';
            },
            
            // è™•ç†åŒ¯å…¥æª”æ¡ˆé¸æ“‡
            handleImportFile: (file) => {
                if (!file) {
                    elements.fileInfo.textContent = 'è«‹é¸æ“‡æª”æ¡ˆ';
                    elements.fileInfo.className = 'file-info error';
                    return;
                }
                
                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    elements.fileInfo.textContent = 'è«‹é¸æ“‡ JSON æª”æ¡ˆ';
                    elements.fileInfo.className = 'file-info error';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        const validation = utils.validateImportData(data);
                        
                        if (!validation.valid) {
                            elements.fileInfo.textContent = `âŒ é©—è­‰å¤±æ•—: ${validation.error}`;
                            elements.fileInfo.className = 'file-info error';
                            appState.importData = null;
                            elements.confirmImportBtn.classList.add('hidden');
                            elements.importPreview.classList.add('hidden');
                            return;
                        }
                        
                        // ä¿å­˜é©—è­‰é€šéçš„è³‡æ–™
                        appState.importData = validation.data;
                        
                        // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
                        elements.fileInfo.textContent = `âœ… æª”æ¡ˆæœ‰æ•ˆ (${utils.formatFileSize(file.size)})`;
                        elements.fileInfo.className = 'file-info success';
                        
                        // é¡¯ç¤ºé è¦½
                        app.showImportPreview(validation.data);
                        
                        // é¡¯ç¤ºç¢ºèªæŒ‰éˆ•
                        elements.confirmImportBtn.classList.remove('hidden');
                        
                        utils.showNotification('æª”æ¡ˆé©—è­‰æˆåŠŸï¼Œè«‹ç¢ºèªå¾ŒåŒ¯å…¥');
                        
                    } catch (error) {
                        elements.fileInfo.textContent = `âŒ è§£æå¤±æ•—: ${error.message}`;
                        elements.fileInfo.className = 'file-info error';
                        appState.importData = null;
                        elements.confirmImportBtn.classList.add('hidden');
                        elements.importPreview.classList.add('hidden');
                    }
                };
                
                reader.onerror = () => {
                    elements.fileInfo.textContent = 'âŒ è®€å–æª”æ¡ˆå¤±æ•—';
                    elements.fileInfo.className = 'file-info error';
                };
                
                reader.readAsText(file);
            },
            
            // é¡¯ç¤ºåŒ¯å…¥é è¦½
            showImportPreview: (data) => {
                const mode = document.querySelector('input[name="importMode"]:checked').value;
                const modeText = mode === 'merge' ? 'åˆä½µ' : 'è¦†è“‹';
                
                let previewHTML = `
                    <h4>ğŸ“Š åŒ¯å…¥è³‡æ–™é è¦½ (${modeText}æ¨¡å¼)</h4>
                    <div class="data-summary">
                        <strong>ğŸ“ è¨˜éŒ„:</strong> ${data.records.length} ç­†<br>
                        <strong>ğŸ“š ç§‘ç›®:</strong> ${data.categories.length} é …<br>
                        <strong>ğŸ“ åœ°é»:</strong> ${data.locations.length} é …<br>
                        <strong>ğŸ“… åŒ¯å‡ºæ—¥æœŸ:</strong> ${new Date(data.exportDate).toLocaleString('zh-TW')}<br>
                        <br>
                `;
                
                if (mode === 'merge') {
                    // åˆä½µæ¨¡å¼é è¦½
                    const newRecords = data.records.filter(r => !appState.records.some(exist => exist.id === r.id));
                    const newCategories = data.categories.filter(c => !appState.categories.includes(c));
                    const newLocations = data.locations.filter(l => !appState.locations.includes(l));
                    
                    previewHTML += `<strong>âœ… é è¨ˆæ–°å¢:</strong><br>`;
                    previewHTML += `- è¨˜éŒ„: ${newRecords.length} ç­†<br>`;
                    previewHTML += `- ç§‘ç›®: ${newCategories.length} é …${newCategories.length > 0 ? ' (' + newCategories.join(', ') + ')' : ''}<br>`;
                    previewHTML += `- åœ°é»: ${newLocations.length} é …${newLocations.length > 0 ? ' (' + newLocations.join(', ') + ')' : ''}<br>`;
                    
                    if (data.records.length > newRecords.length) {
                        previewHTML += `<br><strong>âš ï¸ æ³¨æ„:</strong> ${data.records.length - newRecords.length} ç­†é‡è¤‡è¨˜éŒ„å°‡è¢«å¿½ç•¥`;
                    }
                    
                } else {
                    // è¦†è“‹æ¨¡å¼é è¦½
                    previewHTML += `<strong>âš ï¸ è­¦å‘Š:</strong> æ­¤æ“ä½œå°‡å®Œå…¨å–ä»£ç¾æœ‰è³‡æ–™ï¼<br>`;
                    previewHTML += `- ç¾æœ‰ ${appState.records.length} ç­†è¨˜éŒ„å°‡è¢«æ¸…é™¤<br>`;
                    previewHTML += `- ç¾æœ‰ ${appState.categories.length} é …ç§‘ç›®å°‡è¢«æ¸…é™¤<br>`;
                    previewHTML += `- ç¾æœ‰ ${appState.locations.length} é …åœ°é»å°‡è¢«æ¸…é™¤<br>`;
                }
                
                previewHTML += `</div>`;
                elements.importPreview.innerHTML = previewHTML;
                elements.importPreview.classList.remove('hidden');
            },
            
            // åŸ·è¡ŒåŒ¯å…¥
            executeImport: () => {
                if (!appState.importData) {
                    utils.showNotification('æ²’æœ‰å¯åŒ¯å…¥çš„è³‡æ–™', true);
                    return;
                }
                
                const mode = document.querySelector('input[name="importMode"]:checked').value;
                
                if (mode === 'merge') {
                    // åˆä½µæ¨¡å¼
                    const existingIds = new Set(appState.records.map(r => r.id));
                    const newRecords = appState.importData.records.filter(r => !existingIds.has(r.id));
                    
                    appState.records = [...newRecords, ...appState.records];
                    
                    // åˆä½µç§‘ç›®ï¼ˆå»é‡ï¼‰
                    const categorySet = new Set([...appState.categories, ...appState.importData.categories]);
                    appState.categories = Array.from(categorySet);
                    
                    // åˆä½µåœ°é»ï¼ˆå»é‡ï¼‰
                    const locationSet = new Set([...appState.locations, ...appState.importData.locations]);
                    appState.locations = Array.from(locationSet);
                    
                    utils.showNotification(`æˆåŠŸåˆä½µ ${newRecords.length} ç­†è¨˜éŒ„`);
                    
                } else {
                    // è¦†è“‹æ¨¡å¼
                    if (!confirm('âš ï¸ ç¢ºå®šè¦è¦†è“‹æ‰€æœ‰ç¾æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                        return;
                    }
                    
                    appState.records = appState.importData.records;
                    appState.categories = appState.importData.categories;
                    appState.locations = appState.importData.locations;
                    
                    utils.showNotification('è³‡æ–™å·²å®Œå…¨è¦†è“‹');
                }
                
                // ä¿å­˜ä¸¦æ›´æ–°ä»‹é¢
                app.saveData();
                app.updateAllSelects();
                app.renderCategoriesList();
                app.renderLocationsList();
                app.renderRecordsList();
                app.updateSummary();
                app.updateYearSelector();
                app.updateRecordListYearSelector();
                
                // é‡ç½®åŒ¯å…¥å€å¡Š
                app.resetImportSection();
                
                // é—œé–‰æ¨¡æ…‹æ¡†
                elements.importConfirmModal.classList.add('hidden');
                elements.importConfirmModal.style.display = 'none';
            },
            
            // é‡ç½®åŒ¯å…¥å€å¡Š
            resetImportSection: () => {
                appState.importData = null;
                elements.importFileInput.value = '';
                elements.fileInfo.textContent = '';
                elements.fileInfo.className = 'file-info';
                elements.importPreview.classList.add('hidden');
                elements.confirmImportBtn.classList.add('hidden');
            },
            
            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            setupEventListeners: () => {
                // æ¨™ç±¤åˆ‡æ›
                elements.tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // ç§»é™¤æ‰€æœ‰activeé¡
                        elements.tabBtns.forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        // æ·»åŠ activeé¡
                        btn.classList.add('active');
                        const tabId = btn.dataset.tab + '-tab';
                        document.getElementById(tabId).classList.add('active');
                    });
                });
                
                // è¡¨å–®æäº¤
                elements.recordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const recordData = {
                        date: elements.recordDate.value,
                        time: elements.recordTime.value,
                        type: elements.recordType.value,
                        category: elements.recordCategory.value,
                        location: elements.recordLocation.value,
                        amount: elements.recordAmount.value,
                        summary: elements.recordSummary.value,
                        receiptImage: appState.currentPhoto || ''
                    };
                    
                    // ç°¡å–®é©—è­‰
                    if (!recordData.date || !recordData.time || !recordData.type || 
                        !recordData.category || !recordData.location || !recordData.amount) {
                        utils.showNotification('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«å­—æ®µ', true);
                        return;
                    }
                    
                    app.addRecord(recordData);
                    app.resetForm();
                });
                
                // ç…§ç‰‡åŠŸèƒ½
                elements.takePhotoBtn.addEventListener('click', () => {
                    elements.photoFileInput.setAttribute('capture', 'camera');
                    elements.photoFileInput.click();
                });
                
                elements.uploadPhotoBtn.addEventListener('click', () => {
                    elements.photoFileInput.removeAttribute('capture');
                    elements.photoFileInput.click();
                });
                
                elements.photoFileInput.addEventListener('change', async (e) => {
                    if (e.target.files && e.target.files[0]) {
                        try {
                            const base64Image = await utils.processImage(e.target.files[0]);
                            appState.currentPhoto = base64Image;
                            elements.photoPreview.src = base64Image;
                            elements.photoPreviewContainer.classList.remove('hidden');
                            elements.photoPrompt.classList.add('hidden');
                            elements.removePhotoBtn.classList.remove('hidden');
                            elements.photoArea.classList.add('has-image');
                            utils.showNotification('åœ–ç‰‡å·²ä¸Šå‚³');
                            
                            // é»æ“Šåœ–ç‰‡æŸ¥çœ‹å¤§åœ–
                            elements.photoPreview.onclick = () => {
                                elements.receiptImage.src = base64Image;
                                elements.receiptModal.classList.remove('hidden');
                                elements.receiptModal.style.display = 'flex';
                            };
                        } catch (error) {
                            utils.showNotification(error.message, true);
                        }
                    }
                });
                
                elements.removePhotoBtn.addEventListener('click', () => {
                    appState.currentPhoto = null;
                    elements.photoFileInput.value = '';
                    elements.photoPreviewContainer.classList.add('hidden');
                    elements.photoPrompt.classList.remove('hidden');
                    elements.removePhotoBtn.classList.add('hidden');
                    elements.photoArea.classList.remove('has-image');
                    elements.photoPreview.onclick = null;
                    utils.showNotification('åœ–ç‰‡å·²ç§»é™¤');
                });
                
                // é‡ç½®æŒ‰éˆ•
                elements.resetFormBtn.addEventListener('click', app.resetForm);
                
                // ç§‘ç›®ç®¡ç†
                elements.addCategoryBtn.addEventListener('click', () => {
                    app.addCategory(elements.newCategory.value);
                });
                
                elements.newCategory.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        app.addCategory(elements.newCategory.value);
                    }
                });
                
                // åœ°é»ç®¡ç†
                elements.addLocationBtn.addEventListener('click', () => {
                    app.addLocation(elements.newLocation.value);
                });
                
                elements.newLocation.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        app.addLocation(elements.newLocation.value);
                    }
                });
                
                // è¨˜éŒ„åˆ—è¡¨éæ¿¾å™¨
                elements.applyFilterBtn.addEventListener('click', app.applyFilters);
                elements.clearFilterBtn.addEventListener('click', app.clearFilters);
                
                // çµ±è¨ˆç¯©é¸
                elements.applySummaryFilterBtn.addEventListener('click', app.applySummaryFilter);
                elements.clearSummaryFilterBtn.addEventListener('click', app.clearSummaryFilter);
                
                // åŒ¯å…¥/åŒ¯å‡ºåŠŸèƒ½
                elements.exportBtn.addEventListener('click', app.exportData);
                elements.copyJsonBtn.addEventListener('click', app.copyJsonData);
                elements.copyToClipboardBtn.addEventListener('click', app.copyToClipboard);
                elements.closeCopyAreaBtn.addEventListener('click', app.closeCopyArea);
                
                elements.importFileInput.addEventListener('change', (e) => {
                    app.handleImportFile(e.target.files[0]);
                });
                
                elements.confirmImportBtn.addEventListener('click', () => {
                    // é¡¯ç¤ºç¢ºèªæ¨¡æ…‹æ¡†
                    const mode = document.querySelector('input[name="importMode"]:checked').value;
                    const modeText = mode === 'merge' ? 'åˆä½µ' : 'è¦†è“‹';
                    
                    elements.importConfirmMessage.innerHTML = `
                        <p>æ‚¨é¸æ“‡äº† <strong>${modeText}æ¨¡å¼</strong>ï¼Œæº–å‚™åŒ¯å…¥è³‡æ–™ï¼š</p>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>è¨˜éŒ„: ${appState.importData.records.length} ç­†</li>
                            <li>ç§‘ç›®: ${appState.importData.categories.length} é …</li>
                            <li>åœ°é»: ${appState.importData.locations.length} é …</li>
                        </ul>
                        <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px;">
                            âš ï¸ è«‹ç¢ºèªè³‡æ–™ä¾†æºå®‰å…¨ï¼Œä¸¦æ³¨æ„è¦†è“‹æ¨¡å¼å°‡æœƒ<b>æ°¸ä¹…åˆªé™¤</b>ç¾æœ‰è³‡æ–™ï¼
                        </p>
                    `;
                    
                    elements.importConfirmModal.classList.remove('hidden');
                    elements.importConfirmModal.style.display = 'flex';
                });
                
                // ç›£è½åŒ¯å…¥æ¨¡å¼è®Šæ›´
                document.querySelectorAll('input[name="importMode"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        appState.importMode = radio.value;
                        // å¦‚æœå·²æœ‰é è¦½ï¼Œé‡æ–°é¡¯ç¤º
                        if (appState.importData && !elements.importPreview.classList.contains('hidden')) {
                            app.showImportPreview(appState.importData);
                        }
                    });
                });
                
                // åŒ¯å…¥ç¢ºèªæ¨¡æ…‹æ¡†æŒ‰éˆ•
                elements.finalImportBtn.addEventListener('click', () => {
                    app.executeImport();
                });
                
                elements.cancelImportBtn.addEventListener('click', () => {
                    elements.importConfirmModal.classList.add('hidden');
                    elements.importConfirmModal.style.display = 'none';
                });
                
                elements.closeImportConfirmModal.addEventListener('click', () => {
                    elements.importConfirmModal.classList.add('hidden');
                    elements.importConfirmModal.style.display = 'none';
                });
                
                // åˆªé™¤æ¨¡æ…‹æ¡†
                elements.closeDeleteModal.addEventListener('click', () => {
                    elements.deleteModal.classList.add('hidden');
                    elements.deleteModal.style.display = 'none';
                    appState.deleteTargetId = null;
                });
                
                elements.cancelDeleteBtn.addEventListener('click', () => {
                    elements.deleteModal.classList.add('hidden');
                    elements.deleteModal.style.display = 'none';
                    appState.deleteTargetId = null;
                });
                
                elements.confirmDeleteBtn.addEventListener('click', () => {
                    if (appState.deleteTargetId) {
                        app.deleteRecord(appState.deleteTargetId);
                        elements.deleteModal.classList.add('hidden');
                        elements.deleteModal.style.display = 'none';
                        appState.deleteTargetId = null;
                    }
                });
                
                // æ”¶æ“šæ¨¡æ…‹æ¡†
                elements.closeReceiptModal.addEventListener('click', () => {
                    elements.receiptModal.classList.add('hidden');
                    elements.receiptModal.style.display = 'none';
                    elements.receiptImage.src = '';
                });
                
                // é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
                elements.deleteModal.addEventListener('click', (e) => {
                    if (e.target === elements.deleteModal) {
                        elements.deleteModal.classList.add('hidden');
                        elements.deleteModal.style.display = 'none';
                        appState.deleteTargetId = null;
                    }
                });
                
                elements.receiptModal.addEventListener('click', (e) => {
                    if (e.target === elements.receiptModal) {
                        elements.receiptModal.classList.add('hidden');
                        elements.receiptModal.style.display = 'none';
                        elements.receiptImage.src = '';
                    }
                });
                
                elements.importConfirmModal.addEventListener('click', (e) => {
                    if (e.target === elements.importConfirmModal) {
                        elements.importConfirmModal.classList.add('hidden');
                        elements.importConfirmModal.style.display = 'none';
                    }
                });
                
                // éµç›¤äº‹ä»¶ï¼šESC éµé—œé–‰æ¨¡æ…‹æ¡†
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        app.hideAllModals();
                    }
                });
            }
        };

        // å•Ÿå‹•æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>