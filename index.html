<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a6fa5">
    <title>å¤šå¸³å†Šæ™ºèƒ½è¨˜å¸³ç¨‹å¼</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cbc;
            --accent-color: #ff6b6b;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 50px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 20px;
        }

        h1 { font-size: 1.8rem; margin-bottom: 5px; }
        .date-display { font-size: 1.1rem; opacity: 0.9; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 10px 20px;
            background-color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: var(--box-shadow);
            white-space: nowrap;
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-btn:hover { transform: translateY(-2px); }

        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Forms */
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* 3æ¬„ä½ä½ˆå±€å°ˆç”¨ (å¹£åˆ¥/åŒ¯ç‡/é‡‘é¡) */
        .form-row-3 {
            display: grid;
            grid-template-columns: 0.8fr 1fr 1.2fr;
            gap: 15px;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        label span.required {
            color: var(--accent-color);
            margin-left: 3px;
        }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            width: 100%;
        }

        input:read-only {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        textarea { min-height: 80px; resize: vertical; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-align: center;
            white-space: nowrap;
        }

        .btn:hover { background-color: var(--secondary-color); transform: translateY(-2px); }
        .btn-danger { background-color: var(--accent-color); }
        .btn-danger:hover { background-color: #ff5252; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #218838; }
        .btn-warning { background-color: var(--warning-color); color: #333; }
        .btn-warning:hover { background-color: #e0a800; }
        .btn-info { background-color: var(--info-color); }
        .btn-info:hover { background-color: #138496; }
        .btn-cancel { background-color: #6c757d; }
        .btn-cancel:hover { background-color: #5a6268; }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        /* Type Selector */
        .type-selector {
            display: flex;
            gap: 10px;
        }

        .type-option {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        .type-option:hover { background-color: #f8f9fa; }
        
        .type-option.selected {
            border-color: var(--primary-color);
            background-color: var(--primary-color);
            color: white;
        }

        .type-option.income.selected {
            border-color: var(--success-color);
            background-color: var(--success-color);
        }

        .type-option.expense.selected {
            border-color: var(--accent-color);
            background-color: var(--accent-color);
        }

        /* Filter Section */
        .filter-section {
            background: #f0f4f8;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border: 1px solid #d0d8e0;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-grid .form-group { margin: 0; }

        /* Record Cards */
        .record-list { display: grid; gap: 15px; }
        .record-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color);
            transition: var(--transition);
        }
        .record-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
        .record-card.income { border-left-color: var(--success-color); }
        .record-card.expense { border-left-color: var(--accent-color); }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .record-date { font-weight: 600; color: var(--dark-color); font-size: 0.9rem; }
        .record-book-badge {
            font-size: 0.8rem;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
            color: #495057;
            margin-left: 5px;
        }
        .record-amount-group {
            text-align: right;
        }
        .record-amount { font-weight: 700; font-size: 1.2rem; }
        .record-amount.income { color: var(--success-color); }
        .record-amount.expense { color: var(--accent-color); }
        .record-original-amount { font-size: 0.85rem; color: #888; margin-top: 2px; }

        .record-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 5px;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        .record-summary {
            font-style: italic;
            color: #555;
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #ddd;
        }

        .record-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 5px;
        }
        .record-actions button { padding: 4px 10px; font-size: 0.85rem; }

        /* Stats & Cards */
        .summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            margin-bottom: 15px;
        }
        .summary-card h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 8px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .summary-item {
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
        }
        .summary-value { font-size: 1.3rem; font-weight: 700; margin-top: 5px; }
        .income-text { color: var(--success-color); }
        .expense-text { color: var(--accent-color); }

        /* Account Book Management */
        .book-list {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }
        .book-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 20px;
            position: relative;
        }
        .book-card.active-book {
            border: 2px solid var(--primary-color);
            background-color: #f0f7ff;
        }
        .book-card h4 { margin-bottom: 5px; font-size: 1.2rem; color: var(--primary-color); }
        .book-meta { font-size: 0.9rem; color: #666; margin-bottom: 10px; }
        .book-currency { 
            display: inline-block; 
            background: var(--warning-color); 
            color: #333; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
            font-weight: bold;
        }

        /* Modal */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; justify-content: center; align-items: center;
            z-index: 9999; backdrop-filter: blur(3px);
        }
        .modal.show { display: flex; animation: modalFadeIn 0.3s ease; }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-content {
            background-color: white; padding: 25px;
            border-radius: var(--border-radius);
            max-width: 500px; width: 90%;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;
        }
        .close-modal { font-size: 1.5rem; cursor: pointer; border: none; background: none; }

        /* Notification */
        .notification {
            position: fixed; top: 20px; right: 20px; padding: 15px 20px;
            background-color: var(--success-color); color: white;
            border-radius: var(--border-radius); box-shadow: var(--box-shadow);
            z-index: 10000; transform: translateX(200%); transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
        .notification.error { background-color: var(--accent-color); }

        /* Utility */
        .hidden { display: none !important; }
        .empty-state { text-align: center; padding: 40px; color: #888; }
        .form-title {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color);
        }
        .form-title h2 { color: var(--primary-color); }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: flex-start; }
            .form-row, .form-row-3 { grid-template-columns: 1fr; gap: 10px; }
            .record-header { align-items: flex-start; }
            .type-selector { flex-direction: row; }
            .filter-grid { grid-template-columns: 1fr 1fr; }
        }
        @media (max-width: 480px) {
            .filter-grid { grid-template-columns: 1fr; }
            .record-amount { font-size: 1.1rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>ğŸ’° å¤šå¸³å†Šæ™ºèƒ½è¨˜å¸³ <span style="font-size: 14px; opacity: 0.8; font-weight: normal;">v2026.02</span></h1>
                    <div class="date-display" id="currentDate"></div>
                </div>
                <div id="headerTotal" style="font-weight: bold; font-size: 1.1rem; margin-top: 10px;">
                    </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="record">ğŸ“ è¨˜å¸³</button>
            <button class="tab-btn" data-tab="records">ğŸ“‹ è¨˜éŒ„åˆ—è¡¨</button>
            <button class="tab-btn" data-tab="books">ğŸ“• å¸³å†Šç®¡ç†</button>
            <button class="tab-btn" data-tab="categories">ğŸ“š ç§‘ç›®ç®¡ç†</button>
            <button class="tab-btn" data-tab="summary">ğŸ“Š çµ±è¨ˆåˆ†æ</button>
            <button class="tab-btn" data-tab="data">âš™ï¸ è³‡æ–™ç¶­è­·</button>
        </div>

        <div class="tab-content active" id="record-tab">
            <div class="form-title">
                <h2 id="formModeTitle">æ–°å¢è¨˜éŒ„</h2>
                <button id="cancelEditBtn" class="btn btn-cancel hidden">å–æ¶ˆç·¨è¼¯</button>
            </div>
            
            <form id="recordForm">
                <div class="form-group">
                    <label for="recordBook">å¸³å†Š <span class="required">*</span></label>
                    <select id="recordBook" required>
                        </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="recordDate">æ—¥æœŸ <span class="required">*</span></label>
                        <input type="date" id="recordDate" required>
                    </div>
                    <div class="form-group">
                        <label for="recordTime">æ™‚é–“ <span class="required">*</span></label>
                        <input type="time" id="recordTime" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>æ”¶æ”¯åˆ¥ <span class="required">*</span></label>
                    <div class="type-selector">
                        <div class="type-option expense selected" data-type="expense">æ”¯å‡º</div>
                        <div class="type-option income" data-type="income">æ”¶å…¥</div>
                    </div>
                    <input type="hidden" id="recordType" value="expense">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="recordMainCategory">ä¸»ç§‘ç›® <span class="required">*</span></label>
                        <select id="recordMainCategory" required>
                            <option value="">è«‹é¸æ“‡</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordSubCategory">å­ç§‘ç›® <span class="required">*</span></label>
                        <select id="recordSubCategory" required>
                            <option value="">è«‹å…ˆé¸æ“‡ä¸»ç§‘ç›®</option>
                        </select>
                    </div>
                </div>

                <div class="form-row-3">
                    <div class="form-group">
                        <label for="recordCurrency">å¹£åˆ¥</label>
                        <input type="text" id="recordCurrency" readonly title="ç”±å¸³å†Šè¨­å®šå¸¶å…¥">
                    </div>
                    <div class="form-group">
                        <label for="recordRate">åŒ¯ç‡ (å°å°å¹£)</label>
                        <input type="number" id="recordRate" step="0.0001" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="recordAmount">é‡‘é¡ <span class="required">*</span></label>
                        <input type="number" id="recordAmount" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recordSummary">æ‘˜è¦</label>
                    <input type="text" id="recordSummary" placeholder="é¸å¡«ï¼Œè¼¸å…¥å‚™è¨»èªªæ˜...">
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn btn-success" id="submitFormBtn">ğŸ’¾ ä¿å­˜è¨˜éŒ„</button>
                    <button type="button" class="btn" id="resetFormBtn">ğŸ”„ é‡ç½®è¡¨å–®</button>
                </div>
            </form>
        </div>

        <div class="tab-content" id="records-tab">
            <div class="filter-section">
                <h3>ğŸ” ç¯©é¸æ¢ä»¶</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label>å¹´ä»½</label>
                        <select id="filterYear"><option value="">å…¨éƒ¨</option></select>
                    </div>
                    <div class="form-group">
                        <label>æœˆä»½</label>
                        <select id="filterMonth">
                            <option value="">å…¨éƒ¨</option>
                            <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¸³å†Š</label>
                        <select id="filterBook"><option value="">å…¨éƒ¨</option></select>
                    </div>
                    <div class="form-group">
                        <label>æ”¶æ”¯åˆ¥</label>
                        <select id="filterType">
                            <option value="">å…¨éƒ¨</option>
                            <option value="income">æ”¶å…¥</option>
                            <option value="expense">æ”¯å‡º</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä¸»ç§‘ç›®</label>
                        <select id="filterMainCategory"><option value="">å…¨éƒ¨</option></select>
                    </div>
                    <div class="form-group">
                        <label>å­ç§‘ç›®</label>
                        <select id="filterSubCategory"><option value="">å…¨éƒ¨</option></select>
                    </div>
                    <div class="form-group">
                        <label>æ‘˜è¦é—œéµå­—</label>
                        <input type="text" id="filterKeyword" placeholder="æœå°‹æ‘˜è¦...">
                    </div>
                </div>
                <div class="btn-group" style="justify-content: flex-end;">
                    <button class="btn" id="applyFilterBtn">ğŸ” æœå°‹</button>
                    <button class="btn btn-cancel" id="clearFilterBtn">âœ–ï¸ æ¸…é™¤</button>
                </div>
            </div>
            <div id="recordsList" class="record-list">
                </div>
        </div>

        <div class="tab-content" id="books-tab">
            <div class="form-title">
                <h2>å¸³å†Šç®¡ç†</h2>
                <button class="btn btn-success" id="showAddBookModalBtn">â• æ–°å¢å¸³å†Š</button>
            </div>
            <div id="bookListContainer" class="book-list">
                </div>
        </div>

        <div class="tab-content" id="categories-tab">
            <div class="form-row">
                <div>
                    <h3>ä¸»ç§‘ç›®</h3>
                    <div class="form-group" style="flex-direction: row; gap: 5px;">
                        <input type="text" id="newMainCatInput" placeholder="æ–°ä¸»ç§‘ç›®åç¨±">
                        <button class="btn btn-success" id="addMainCatBtn">æ–°å¢</button>
                    </div>
                    <div id="mainCatList" style="margin-top: 10px;"></div>
                </div>
                <div>
                    <h3>å­ç§‘ç›®</h3>
                    <div class="form-group">
                        <label id="selectedMainCatLabel" style="color: var(--primary-color);">è«‹å…ˆé»é¸å·¦å´ä¸»ç§‘ç›®</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newSubCatInput" placeholder="æ–°å­ç§‘ç›®åç¨±" disabled>
                            <button class="btn btn-success" id="addSubCatBtn" disabled>æ–°å¢</button>
                        </div>
                    </div>
                    <div id="subCatList" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="summary-tab">
            <div class="filter-section">
                <h3>ğŸ“Š çµ±è¨ˆç¯©é¸ (é‡‘é¡çš†æ›ç®—ç‚ºå°å¹£)</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label>å¹´ä»½</label>
                        <select id="summaryYear"><option value="">å…¨éƒ¨</option></select>
                    </div>
                    <div class="form-group">
                        <label>æœˆä»½</label>
                        <select id="summaryMonth">
                            <option value="">å…¨éƒ¨</option>
                            <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¸³å†Š</label>
                        <select id="summaryBook"><option value="">å…¨éƒ¨ (è·¨å¸³å†Š)</option></select>
                    </div>
                </div>
                <div class="btn-group" style="margin-top: 10px;">
                    <button class="btn" id="runSummaryBtn">ğŸ“Š ç”¢ç”Ÿå ±è¡¨</button>
                </div>
            </div>

            <div id="summaryResults" class="hidden">
                <div class="summary-card">
                    <h3>ç¸½æ”¶æ”¯æ¦‚æ³ (TWD)</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <div>ç¸½æ”¶å…¥</div>
                            <div class="summary-value income-text" id="sumIncome">0</div>
                        </div>
                        <div class="summary-item">
                            <div>ç¸½æ”¯å‡º</div>
                            <div class="summary-value expense-text" id="sumExpense">0</div>
                        </div>
                        <div class="summary-item">
                            <div>æ·¨åˆ©</div>
                            <div class="summary-value" id="sumNet">0</div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="summary-card">
                        <h3>æ”¯å‡ºåˆ†é¡çµ±è¨ˆ</h3>
                        <div id="expenseCatChart"></div>
                    </div>
                    <div class="summary-card">
                        <h3>æ”¶å…¥åˆ†é¡çµ±è¨ˆ</h3>
                        <div id="incomeCatChart"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="data-tab">
            <h3>è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
            <p>å°‡æ‰€æœ‰è¨˜å¸³è³‡æ–™(å«å¸³å†Šã€è¨­å®š)åŒ¯å‡ºç‚º JSON æª”ï¼Œæˆ–å¾ JSON æª”é‚„åŸã€‚</p>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-info" id="exportDataBtn">ğŸ“¤ åŒ¯å‡ºè³‡æ–™ (JSON)</button>
                <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (JSON)</button>
                <input type="file" id="importFile" accept=".json" class="hidden">
            </div>
            <hr style="margin: 20px 0;">
            <button class="btn btn-danger" id="clearAllDataBtn">âš ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
        </div>
    </div>

    <div id="bookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bookModalTitle">æ–°å¢å¸³å†Š</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="bookForm">
                <input type="hidden" id="bookId">
                <div class="form-group">
                    <label>å¸³å†Šåç¨± <span class="required">*</span></label>
                    <input type="text" id="bookName" required placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»è²»ã€æ—…éŠåŸºé‡‘">
                </div>
                <div class="form-group">
                    <label>ç”¨é€”èªªæ˜</label>
                    <input type="text" id="bookPurpose" placeholder="ä¾‹å¦‚ï¼šæ—¥å¸¸é–‹éŠ·ä½¿ç”¨">
                </div>
                <div class="form-group">
                    <label>å¹£åˆ¥ <span class="required">*</span></label>
                    <select id="bookCurrency" required>
                        <option value="TWD">å°å¹£ (TWD)</option>
                        <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                        <option value="USD">ç¾é‡‘ (USD)</option>
                        <option value="JPY">æ—¥åœ“ (JPY)</option>
                        <option value="EUR">æ­å…ƒ (EUR)</option>
                    </select>
                    <small style="color: #666; margin-top: 5px;">æ³¨æ„ï¼šå»ºç«‹å¾Œï¼Œå¹£åˆ¥ä¸å¯ä¿®æ”¹ã€‚</small>
                </div>
                <div class="btn-group" style="justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-cancel close-modal-btn">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // --- æ ¸å¿ƒè³‡æ–™èˆ‡ç‹€æ…‹ ---
        const DEFAULT_CATEGORIES = {
            'é£²é£Ÿ': ['æ—©é¤', 'åˆé¤', 'æ™šé¤', 'é£²æ–™', 'é›¶é£Ÿ'],
            'äº¤é€š': ['å…¬è»Š', 'æ·é‹', 'è¨ˆç¨‹è»Š', 'æ²¹è³‡', 'åœè»Šè²»'],
            'å¨›æ¨‚': ['é›»å½±', 'KTV', 'æ—…éŠ', 'é‹å‹•', 'éŠæˆ²'],
            'ç”Ÿæ´»': ['æˆ¿ç§Ÿ', 'æ°´é›»', 'ç¶²è·¯', 'æ‰‹æ©Ÿ', 'æ—¥ç”¨å“'],
            'æ”¶å…¥': ['è–ªæ°´', 'çé‡‘', 'æŠ•è³‡', 'å…¼è·', 'å…¶ä»–'],
            'å…¶ä»–': ['é†«ç™‚', 'æ•™è‚²', 'ç¦®ç‰©', 'ææ¬¾']
        };

        // é è¨­åŒ¯ç‡ (åƒè€ƒå€¼ï¼Œå¯¦éš›æ“ä½œæ™‚ç”¨æˆ¶å¯æ”¹)
        const BASE_RATES = {
            'TWD': 1,
            'USD': 32.5,
            'CNY': 4.5,
            'JPY': 0.22,
            'EUR': 35.0
        };

        const appState = {
            records: [],
            categories: {},
            accountBooks: [],
            editingRecordId: null,
            editingBookId: null,
            
            // æš«å­˜ç‹€æ…‹
            currentMainCat: null
        };

        // --- å·¥å…·å‡½å¼ ---
        const utils = {
            uuid: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatMoney: (amount, currency = 'TWD') => {
                return new Intl.NumberFormat('zh-TW', { 
                    style: 'decimal', 
                    minimumFractionDigits: currency === 'JPY' ? 0 : 2,
                    maximumFractionDigits: 2
                }).format(amount);
            },
            showNotify: (msg, type = 'success') => {
                const el = document.getElementById('notification');
                el.textContent = msg;
                el.className = `notification show ${type === 'error' ? 'error' : ''}`;
                setTimeout(() => el.classList.remove('show'), 3000);
            },
            save: () => {
                localStorage.setItem('acc_records', JSON.stringify(appState.records));
                localStorage.setItem('acc_categories', JSON.stringify(appState.categories));
                localStorage.setItem('acc_books', JSON.stringify(appState.accountBooks));
            },
            getToday: () => new Date().toISOString().split('T')[0],
            getTime: () => new Date().toTimeString().split(' ')[0].substr(0, 5)
        };

        // --- åˆå§‹åŒ–èˆ‡è³‡æ–™é·ç§» ---
        function initApp() {
            // è®€å–è³‡æ–™
            const storedRecords = localStorage.getItem('acc_records');
            const storedCats = localStorage.getItem('acc_categories');
            const storedBooks = localStorage.getItem('acc_books');

            appState.categories = storedCats ? JSON.parse(storedCats) : DEFAULT_CATEGORIES;
            appState.accountBooks = storedBooks ? JSON.parse(storedBooks) : [];
            appState.records = storedRecords ? JSON.parse(storedRecords) : [];

            // 1. å¦‚æœæ²’æœ‰å¸³å†Šï¼Œå»ºç«‹é è¨­å¸³å†Š
            if (appState.accountBooks.length === 0) {
                const defaultBook = {
                    id: 'default_book',
                    name: 'é è¨­å¸³æœ¬',
                    purpose: 'ç³»çµ±è‡ªå‹•å»ºç«‹',
                    currency: 'TWD',
                    createdAt: new Date().toISOString()
                };
                appState.accountBooks.push(defaultBook);
            }

            // 2. è³‡æ–™é·ç§»ï¼šæª¢æŸ¥èˆŠç´€éŒ„æ˜¯å¦æœ‰ bookId å’Œ currency è³‡è¨Š
            let dataMigrated = false;
            appState.records.forEach(r => {
                if (!r.bookId) {
                    r.bookId = appState.accountBooks[0].id;
                    r.currency = 'TWD';
                    r.exchangeRate = 1;
                    dataMigrated = true;
                }
                // ç¢ºä¿æ•¸å€¼å‹åˆ¥
                r.amount = parseFloat(r.amount);
                r.exchangeRate = parseFloat(r.exchangeRate || 1);
            });

            if (dataMigrated) utils.save();

            // 3. UI åˆå§‹åŒ–
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('zh-TW', {year:'numeric', month:'long', day:'numeric', weekday:'long'});
            
            initTabs();
            renderBookSelects();
            renderCategorySelects();
            renderYearSelects();
            renderBookList(); // å¸³å†Šç®¡ç†é 
            renderCategoryManagement(); // ç§‘ç›®ç®¡ç†é 
            
            // é è¨­æ—¥æœŸ
            document.getElementById('recordDate').value = utils.getToday();
            document.getElementById('recordTime').value = utils.getTime();

            // è¼‰å…¥åˆ—è¡¨
            filterRecords();
            updateHeaderTotal();
        }

        // --- DOM äº‹ä»¶ç¶å®š ---
        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
                    
                    // åˆ‡æ›æ™‚åˆ·æ–°æŸäº›è³‡æ–™
                    if(btn.dataset.tab === 'records') {
                        renderYearSelects(); // æ›´æ–°ç¯©é¸å¹´ä»½
                        filterRecords();
                    }
                });
            });

            // æ”¶æ”¯åˆ¥åˆ‡æ›
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('recordType').value = this.dataset.type;
                });
            });

            // å¸³å†Šé¸æ“‡æ”¹è®Š -> é€£å‹•å¹£åˆ¥èˆ‡é è¨­åŒ¯ç‡
            document.getElementById('recordBook').addEventListener('change', function() {
                const bookId = this.value;
                const book = appState.accountBooks.find(b => b.id === bookId);
                if (book) {
                    document.getElementById('recordCurrency').value = book.currency;
                    document.getElementById('recordRate').value = BASE_RATES[book.currency] || 1;
                    // å¦‚æœæ˜¯å°å¹£ï¼Œé–å®šåŒ¯ç‡ç‚º 1 (UIé«”é©—å„ªåŒ–)
                    document.getElementById('recordRate').readOnly = (book.currency === 'TWD');
                }
            });

            // ä¸»ç§‘ç›®æ”¹è®Š -> é€£å‹•å­ç§‘ç›®
            document.getElementById('recordMainCategory').addEventListener('change', (e) => updateSubSelect('recordSubCategory', e.target.value));
            document.getElementById('filterMainCategory').addEventListener('change', (e) => updateSubSelect('filterSubCategory', e.target.value));
        }

        // --- è¨˜å¸³åŠŸèƒ½ ---
        document.getElementById('recordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const bookId = document.getElementById('recordBook').value;
            const book = appState.accountBooks.find(b => b.id === bookId);
            
            const record = {
                id: appState.editingRecordId || utils.uuid(),
                bookId: bookId,
                date: document.getElementById('recordDate').value,
                time: document.getElementById('recordTime').value,
                type: document.getElementById('recordType').value,
                mainCategory: document.getElementById('recordMainCategory').value,
                subCategory: document.getElementById('recordSubCategory').value,
                currency: book.currency,
                exchangeRate: parseFloat(document.getElementById('recordRate').value),
                amount: parseFloat(document.getElementById('recordAmount').value),
                summary: document.getElementById('recordSummary').value,
                updatedAt: new Date().toISOString()
            };

            if (appState.editingRecordId) {
                const idx = appState.records.findIndex(r => r.id === appState.editingRecordId);
                if (idx !== -1) appState.records[idx] = record;
                utils.showNotify('ç´€éŒ„å·²æ›´æ–°');
                exitEditMode();
            } else {
                appState.records.unshift(record); // æ–°çš„åœ¨å‰é¢
                utils.showNotify('ç´€éŒ„å·²æ–°å¢');
                resetForm();
            }
            
            utils.save();
            updateHeaderTotal();
        });

        document.getElementById('resetFormBtn').addEventListener('click', resetForm);
        document.getElementById('cancelEditBtn').addEventListener('click', exitEditMode);

        function resetForm() {
            document.getElementById('recordForm').reset();
            document.getElementById('recordDate').value = utils.getToday();
            document.getElementById('recordTime').value = utils.getTime();
            
            // é‡ç½®æ”¶æ”¯åˆ¥ UI
            document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
            document.querySelector('.type-option.expense').classList.add('selected');
            document.getElementById('recordType').value = 'expense';
            
            // é‡ç½®ä¸¦è§¸ç™¼å¸³å†Šé€£å‹•
            if (appState.accountBooks.length > 0) {
                document.getElementById('recordBook').value = appState.accountBooks[0].id;
                document.getElementById('recordBook').dispatchEvent(new Event('change'));
            }
            
            document.getElementById('recordSubCategory').innerHTML = '<option value="">è«‹å…ˆé¸æ“‡ä¸»ç§‘ç›®</option>';
        }

        function exitEditMode() {
            appState.editingRecordId = null;
            document.getElementById('formModeTitle').textContent = 'æ–°å¢è¨˜éŒ„';
            document.getElementById('submitFormBtn').textContent = 'ğŸ’¾ ä¿å­˜è¨˜éŒ„';
            document.getElementById('cancelEditBtn').classList.add('hidden');
            resetForm();
        }

        // --- åˆ—è¡¨èˆ‡ç¯©é¸åŠŸèƒ½ ---
        function renderRecordsList(data) {
            const container = document.getElementById('recordsList');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</div>';
                return;
            }

            // ä¾ç…§æ—¥æœŸæ™‚é–“æ’åº (æ–°åˆ°èˆŠ)
            data.sort((a, b) => {
                const dtA = new Date(a.date + 'T' + a.time);
                const dtB = new Date(b.date + 'T' + b.time);
                return dtB - dtA;
            });

            data.forEach(r => {
                const book = appState.accountBooks.find(b => b.id === r.bookId);
                const bookName = book ? book.name : 'æœªçŸ¥å¸³å†Š';
                const sign = r.type === 'income' ? '+' : '-';
                
                // è™•ç†é¡¯ç¤ºé‡‘é¡ï¼šå¦‚æœæ˜¯å¤–å¹£ï¼Œé¡¯ç¤ºåŸå¹£ï¼Œå¦‚æœåŒ¯ç‡é1ï¼Œæ‹¬è™Ÿé¡¯ç¤ºç´„åˆå°å¹£
                let amountDisplay = `${r.currency} ${utils.formatMoney(r.amount, r.currency)}`;
                let twdEquiv = '';
                
                if (r.currency !== 'TWD') {
                    const twdVal = Math.round(r.amount * r.exchangeRate);
                    twdEquiv = `<div class="record-original-amount">ç´„ TWD ${utils.formatMoney(twdVal)} (åŒ¯ç‡:${r.exchangeRate})</div>`;
                }

                const div = document.createElement('div');
                div.className = `record-card ${r.type}`;
                div.innerHTML = `
                    <div class="record-header">
                        <div class="record-date">${r.date} ${r.time} <span class="record-book-badge">${bookName}</span></div>
                        <div class="record-amount-group">
                            <div class="record-amount ${r.type}">${sign} ${amountDisplay}</div>
                            ${twdEquiv}
                        </div>
                    </div>
                    <div class="record-details">
                        <span>ğŸ·ï¸ ${r.mainCategory} > ${r.subCategory}</span>
                    </div>
                    ${r.summary ? `<div class="record-summary">${r.summary}</div>` : ''}
                    <div class="record-actions">
                        <button class="btn btn-warning" onclick="editRecord('${r.id}')">âœï¸ ç·¨è¼¯</button>
                        <button class="btn btn-danger" onclick="deleteRecord('${r.id}')">ğŸ—‘ï¸ åˆªé™¤</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterRecords() {
            const y = document.getElementById('filterYear').value;
            const m = document.getElementById('filterMonth').value;
            const b = document.getElementById('filterBook').value;
            const t = document.getElementById('filterType').value;
            const mc = document.getElementById('filterMainCategory').value;
            const sc = document.getElementById('filterSubCategory').value;
            const k = document.getElementById('filterKeyword').value.toLowerCase();

            const filtered = appState.records.filter(r => {
                const rY = r.date.substring(0, 4);
                const rM = r.date.substring(5, 7);
                if (y && rY !== y) return false;
                if (m && rM !== m) return false;
                if (b && r.bookId !== b) return false;
                if (t && r.type !== t) return false;
                if (mc && r.mainCategory !== mc) return false;
                if (sc && r.subCategory !== sc) return false;
                if (k && (!r.summary || !r.summary.toLowerCase().includes(k))) return false;
                return true;
            });

            renderRecordsList(filtered);
        }

        document.getElementById('applyFilterBtn').addEventListener('click', filterRecords);
        document.getElementById('clearFilterBtn').addEventListener('click', () => {
            document.querySelectorAll('#records-tab select').forEach(s => s.value = '');
            document.getElementById('filterKeyword').value = '';
            filterRecords();
        });

        // --- ç·¨è¼¯èˆ‡åˆªé™¤ (è¨˜éŒ„) ---
        window.deleteRecord = (id) => {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
                appState.records = appState.records.filter(r => r.id !== id);
                utils.save();
                filterRecords();
                updateHeaderTotal();
                utils.showNotify('è¨˜éŒ„å·²åˆªé™¤');
            }
        };

        window.editRecord = (id) => {
            const r = appState.records.find(item => item.id === id);
            if (!r) return;

            appState.editingRecordId = id;
            
            // åˆ‡æ›åˆ°è¨˜å¸³é 
            document.querySelector('[data-tab="record"]').click();
            
            // å¡«å…¥è³‡æ–™
            document.getElementById('formModeTitle').textContent = 'ç·¨è¼¯è¨˜éŒ„';
            document.getElementById('submitFormBtn').textContent = 'æ›´æ–°è¨˜éŒ„';
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            document.getElementById('recordBook').value = r.bookId;
            document.getElementById('recordDate').value = r.date;
            document.getElementById('recordTime').value = r.time;
            
            // è§¸ç™¼ Type åˆ‡æ›
            document.querySelectorAll('.type-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`.type-option.${r.type}`).classList.add('selected');
            document.getElementById('recordType').value = r.type;

            document.getElementById('recordMainCategory').value = r.mainCategory;
            // è§¸ç™¼å­ç§‘ç›®æ›´æ–°
            updateSubSelect('recordSubCategory', r.mainCategory);
            document.getElementById('recordSubCategory').value = r.subCategory;

            // è§¸ç™¼å¹£åˆ¥æ›´æ–° (é›–ç„¶å­˜äº†ä½†ç‚ºäº†ä¿éšª)
            document.getElementById('recordBook').dispatchEvent(new Event('change'));
            // è¦†è“‹å›åŸå§‹åŒ¯ç‡ (å¯èƒ½èˆ‡ç¾åœ¨é è¨­ä¸åŒ)
            document.getElementById('recordRate').value = r.exchangeRate;
            
            document.getElementById('recordAmount').value = r.amount;
            document.getElementById('recordSummary').value = r.summary || '';
        };

        // --- å¸³å†Šç®¡ç†é‚è¼¯ ---
        function renderBookList() {
            const container = document.getElementById('bookListContainer');
            container.innerHTML = '';
            appState.accountBooks.forEach(book => {
                const count = appState.records.filter(r => r.bookId === book.id).length;
                const div = document.createElement('div');
                div.className = 'book-card';
                div.innerHTML = `
                    <h4>${book.name} <span class="book-currency">${book.currency}</span></h4>
                    <div class="book-meta">${book.purpose || 'ç„¡æè¿°'}</div>
                    <div class="book-meta">å»ºç«‹æ–¼: ${book.createdAt.split('T')[0]} | è¨˜éŒ„æ•¸: ${count}</div>
                    <div class="btn-group">
                        <button class="btn btn-warning" onclick="editBook('${book.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-danger" onclick="deleteBook('${book.id}')" ${count > 0 ? 'disabled title="å·²æœ‰è¨˜éŒ„ç„¡æ³•åˆªé™¤"' : ''}>åˆªé™¤</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        const bookModal = document.getElementById('bookModal');
        const showBookModal = () => {
             bookModal.classList.add('show');
             bookModal.style.display = 'flex';
        }
        const hideBookModal = () => {
            bookModal.classList.remove('show'); 
            setTimeout(() => bookModal.style.display = 'none', 300);
        }

        document.getElementById('showAddBookModalBtn').addEventListener('click', () => {
            appState.editingBookId = null;
            document.getElementById('bookForm').reset();
            document.getElementById('bookModalTitle').textContent = 'æ–°å¢å¸³å†Š';
            document.getElementById('bookCurrency').disabled = false; // æ–°å¢æ™‚å¯é¸å¹£åˆ¥
            showBookModal();
        });

        document.querySelectorAll('.close-modal, .close-modal-btn').forEach(btn => btn.addEventListener('click', hideBookModal));

        document.getElementById('bookForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('bookName').value;
            const purpose = document.getElementById('bookPurpose').value;
            const currency = document.getElementById('bookCurrency').value;

            if (appState.editingBookId) {
                // ç·¨è¼¯
                const book = appState.accountBooks.find(b => b.id === appState.editingBookId);
                book.name = name;
                book.purpose = purpose;
                // å¹£åˆ¥ä¸å…è¨±ä¿®æ”¹
                utils.showNotify('å¸³å†Šæ›´æ–°æˆåŠŸ');
            } else {
                // æ–°å¢
                const newBook = {
                    id: utils.uuid(),
                    name, purpose, currency,
                    createdAt: new Date().toISOString()
                };
                appState.accountBooks.push(newBook);
                utils.showNotify('å¸³å†Šå»ºç«‹æˆåŠŸ');
            }
            utils.save();
            renderBookList();
            renderBookSelects(); // æ›´æ–°ä¸‹æ‹‰é¸å–®
            hideBookModal();
        });

        window.editBook = (id) => {
            const book = appState.accountBooks.find(b => b.id === id);
            appState.editingBookId = id;
            document.getElementById('bookName').value = book.name;
            document.getElementById('bookPurpose').value = book.purpose;
            document.getElementById('bookCurrency').value = book.currency;
            document.getElementById('bookCurrency').disabled = true; // ç·¨è¼¯æ™‚é–å®šå¹£åˆ¥
            document.getElementById('bookModalTitle').textContent = 'ç·¨è¼¯å¸³å†Š';
            showBookModal();
        };

        window.deleteBook = (id) => {
            if (confirm('ç¢ºå®šåˆªé™¤æ­¤å¸³å†Šï¼Ÿ')) {
                const hasRecords = appState.records.some(r => r.bookId === id);
                if (hasRecords) {
                    alert('æ­¤å¸³å†Šå…§å·²æœ‰è¨˜éŒ„ï¼Œç„¡æ³•åˆªé™¤ã€‚');
                    return;
                }
                appState.accountBooks = appState.accountBooks.filter(b => b.id !== id);
                utils.save();
                renderBookList();
                renderBookSelects();
                utils.showNotify('å¸³å†Šå·²åˆªé™¤');
            }
        };

        // --- ç§‘ç›®ç®¡ç† (ç°¡åŒ–ç‰ˆé‚è¼¯) ---
        function renderCategoryManagement() {
            const mainList = document.getElementById('mainCatList');
            mainList.innerHTML = '';
            
            Object.keys(appState.categories).forEach(cat => {
                const span = document.createElement('button');
                span.className = 'btn btn-info';
                span.style.margin = '0 5px 5px 0';
                span.textContent = cat;
                span.onclick = () => selectMainCatForEdit(cat);
                mainList.appendChild(span);
            });
        }

        function selectMainCatForEdit(cat) {
            appState.currentMainCat = cat;
            document.getElementById('selectedMainCatLabel').textContent = `ç•¶å‰é¸æ“‡ï¼š${cat}`;
            document.getElementById('newSubCatInput').disabled = false;
            document.getElementById('addSubCatBtn').disabled = false;
            
            const subList = document.getElementById('subCatList');
            subList.innerHTML = '';
            appState.categories[cat].forEach(sub => {
                const div = document.createElement('div');
                div.textContent = sub;
                div.style.padding = '5px';
                div.style.borderBottom = '1px solid #eee';
                subList.appendChild(div);
            });
        }

        document.getElementById('addMainCatBtn').addEventListener('click', () => {
            const val = document.getElementById('newMainCatInput').value.trim();
            if(val && !appState.categories[val]) {
                appState.categories[val] = [];
                utils.save();
                renderCategoryManagement();
                renderCategorySelects();
                document.getElementById('newMainCatInput').value = '';
            }
        });

        document.getElementById('addSubCatBtn').addEventListener('click', () => {
            const val = document.getElementById('newSubCatInput').value.trim();
            if(val && appState.currentMainCat) {
                if(!appState.categories[appState.currentMainCat].includes(val)) {
                    appState.categories[appState.currentMainCat].push(val);
                    utils.save();
                    selectMainCatForEdit(appState.currentMainCat); // åˆ·æ–°
                    document.getElementById('newSubCatInput').value = '';
                }
            }
        });

        // --- çµ±è¨ˆåˆ†æ (è·¨å¹£åˆ¥) ---
        document.getElementById('runSummaryBtn').addEventListener('click', () => {
            const y = document.getElementById('summaryYear').value;
            const m = document.getElementById('summaryMonth').value;
            const b = document.getElementById('summaryBook').value;

            let totalIncome = 0;
            let totalExpense = 0;
            const expenseCats = {};
            const incomeCats = {};

            appState.records.forEach(r => {
                const rY = r.date.substring(0, 4);
                const rM = r.date.substring(5, 7);
                if (y && rY !== y) return;
                if (m && rM !== m) return;
                if (b && r.bookId !== b) return;

                // æ ¸å¿ƒé‚è¼¯ï¼šæ›ç®—æˆå°å¹£
                const amountTWD = r.amount * r.exchangeRate;

                if (r.type === 'income') {
                    totalIncome += amountTWD;
                    incomeCats[r.mainCategory] = (incomeCats[r.mainCategory] || 0) + amountTWD;
                } else {
                    totalExpense += amountTWD;
                    expenseCats[r.mainCategory] = (expenseCats[r.mainCategory] || 0) + amountTWD;
                }
            });

            document.getElementById('sumIncome').textContent = utils.formatMoney(totalIncome);
            document.getElementById('sumExpense').textContent = utils.formatMoney(totalExpense);
            const net = totalIncome - totalExpense;
            document.getElementById('sumNet').textContent = utils.formatMoney(net);
            document.getElementById('sumNet').className = `summary-value ${net >= 0 ? 'income-text' : 'expense-text'}`;

            renderChart('expenseCatChart', expenseCats, totalExpense, 'var(--accent-color)');
            renderChart('incomeCatChart', incomeCats, totalIncome, 'var(--success-color)');
            
            document.getElementById('summaryResults').classList.remove('hidden');
        });

        function renderChart(elementId, data, total, color) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            
            if (total === 0) {
                container.innerHTML = '<p style="text-align:center;color:#999;">ç„¡æ•¸æ“š</p>';
                return;
            }

            const sorted = Object.entries(data).sort((a, b) => b[1] - a[1]);
            
            sorted.forEach(([cat, amount]) => {
                const percent = Math.round((amount / total) * 100);
                const bar = document.createElement('div');
                bar.style.marginBottom = '10px';
                bar.innerHTML = `
                    <div style="display:flex;justify-content:space-between;font-size:0.9rem;">
                        <span>${cat}</span>
                        <span>${utils.formatMoney(amount)} (${percent}%)</span>
                    </div>
                    <div style="background:#eee;height:10px;border-radius:5px;overflow:hidden;margin-top:2px;">
                        <div style="background:${color};width:${percent}%;height:100%;"></div>
                    </div>
                `;
                container.appendChild(bar);
            });
        }

        // --- è¼”åŠ©æ¸²æŸ“å‡½å¼ ---
        function renderBookSelects() {
            const opts = appState.accountBooks.map(b => `<option value="${b.id}">${b.name} (${b.currency})</option>`).join('');
            
            // è¨˜å¸³é 
            document.getElementById('recordBook').innerHTML = opts;
            if (appState.accountBooks.length > 0) {
                 // è§¸ç™¼ä¸€æ¬¡ change ä»¥è¨­å®šé è¨­å¹£åˆ¥
                 document.getElementById('recordBook').dispatchEvent(new Event('change'));
            }

            // åˆ—è¡¨ç¯©é¸
            document.getElementById('filterBook').innerHTML = '<option value="">å…¨éƒ¨</option>' + opts;
            // çµ±è¨ˆç¯©é¸
            document.getElementById('summaryBook').innerHTML = '<option value="">å…¨éƒ¨ (è·¨å¸³å†Š)</option>' + opts;
        }

        function renderCategorySelects() {
            const mainSelect = document.getElementById('recordMainCategory');
            const filterMain = document.getElementById('filterMainCategory');
            
            let html = '<option value="">è«‹é¸æ“‡</option>';
            let filterHtml = '<option value="">å…¨éƒ¨</option>';
            
            Object.keys(appState.categories).forEach(cat => {
                html += `<option value="${cat}">${cat}</option>`;
                filterHtml += `<option value="${cat}">${cat}</option>`;
            });
            
            mainSelect.innerHTML = html;
            filterMain.innerHTML = filterHtml;
        }

        function updateSubSelect(elementId, mainCat) {
            const select = document.getElementById(elementId);
            const isFilter = elementId.includes('filter');
            select.innerHTML = isFilter ? '<option value="">å…¨éƒ¨</option>' : '<option value="">è«‹é¸æ“‡</option>';
            
            if (mainCat && appState.categories[mainCat]) {
                appState.categories[mainCat].forEach(sub => {
                    select.innerHTML += `<option value="${sub}">${sub}</option>`;
                });
            }
        }

        function renderYearSelects() {
            const years = new Set(appState.records.map(r => r.date.substring(0, 4)));
            const currentYear = new Date().getFullYear().toString();
            years.add(currentYear);
            
            const sortedYears = Array.from(years).sort().reverse();
            const opts = '<option value="">å…¨éƒ¨</option>' + sortedYears.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
            
            document.getElementById('filterYear').innerHTML = opts;
            document.getElementById('summaryYear').innerHTML = opts;
        }
        
        // æ›´æ–°é ‚éƒ¨å°çµ±è¨ˆ (æœ¬æœˆ TWD)
        function updateHeaderTotal() {
            const now = new Date();
            const y = now.getFullYear().toString();
            const m = (now.getMonth() + 1).toString().padStart(2, '0');
            
            let inc = 0, exp = 0;
            appState.records.forEach(r => {
                if (r.date.startsWith(`${y}-${m}`)) {
                    const twd = r.amount * r.exchangeRate;
                    if (r.type === 'income') inc += twd;
                    else exp += twd;
                }
            });
            
            document.getElementById('headerTotal').innerHTML = 
                `æœ¬æœˆç´¯è¨ˆ (TWD): <span style="color:#a8e6cf">æ”¶å…¥ ${utils.formatMoney(inc)}</span> | <span style="color:#ff8b94">æ”¯å‡º ${utils.formatMoney(exp)}</span>`;
        }

        // --- è³‡æ–™åŒ¯å‡ºåŒ¯å…¥ ---
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            const dataStr = JSON.stringify({
                records: appState.records,
                categories: appState.categories,
                books: appState.accountBooks,
                exportDate: new Date().toISOString()
            });
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `accounting_backup_${utils.getToday()}.json`;
            a.click();
        });

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm(`ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿ\né€™å°‡è¦†è“‹ç¾æœ‰ ${appState.records.length} ç­†è³‡æ–™ã€‚`)) {
                        if(data.records) appState.records = data.records;
                        if(data.categories) appState.categories = data.categories;
                        if(data.books) appState.accountBooks = data.books;
                        utils.save();
                        location.reload();
                    }
                } catch (err) {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('clearAllDataBtn').addEventListener('click', () => {
            if(confirm('è­¦å‘Šï¼é€™å°‡åˆªé™¤ç€è¦½å™¨å…§æ‰€æœ‰è¨˜å¸³è³‡æ–™ï¼Œä¸”ç„¡æ³•å¾©åŸï¼\nç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) {
                localStorage.clear();
                location.reload();
            }
        });

        // å•Ÿå‹•
        initApp();
    </script>
</body>
</html>
